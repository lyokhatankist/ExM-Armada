<?xml version="1.0" encoding="windows-1251" standalone="yes" ?>
<triggers>
	<trigger Name="PlayerDead" active="0">
		<event eventid="GE_VEHICLE_WITHOUT_HEALTH" ObjName="MyCar" />
		<script>
			local Width = 6 -- width of the vessel
			local Height = 3 -- height of the vessel
			local SinkingSpeed = 1500 -- (set to lower numbers for bigger ships)
			local EffectsAmount = 16 -- amount of effects for each stage (set to the higher numbers for bigger ships)
			local PossibleEffects = {
				"ET_PS_SMLBLAST_HEVEHICLEEXPLOSION",
				"ET_PS_SMLBLAST_APVEHICLEEXPLOSION",
				"ET_PS_MEDBLAST_HESTATICSEXPLOSION",
				"ET_PS_MEDBLAST_HEVEHICLEEXPLOSION"
				}
			local PossibleEffects_II = {
				"ET_PS_SMLBLAST_HEWATERSPLASH",
				"ET_PS_MEDBLAST_APWATERSPLASH"
				}

			ChangeSide("neutral")

			local Plf = GetPlayerVehicle()
			local PlfID = GetPlayerVehicleId()
			local PlfCoor = Plf:GetPosition()
			PlfCoor.y = PlfCoor.y + Height
			PlfCoor.z = PlfCoor.z + 25 + Width

			Plf:SetThrottle(0)

			local moverId = CreateNewObject { prototypeName	= "cinematicMover", objName  = "" }
			local mover = GetEntityByID( moverId ) 
			if Plf then
				mover:SetObjAndPath( PlfID, "DeathPath01", SinkingSpeed )
			end

			FlyAround(2, 0.1, (25 + Width*Width/4), 6, PlfCoor, PlfID, 0, 1)
			StartCinematic()

			SetVar("DeathAnimWidth", Width)
			SetVar("DeathAnimHeight", Height)
			SetVar("DeathAnimEffectsAmount", EffectsAmount)
			SetVar("DeathAnimPossibleEffects", TableToString(PossibleEffects))
			SetVar("DeathAnimPossibleEffects_II", TableToString(PossibleEffects_II))
			SetVar("DeathAnim", 0)

			TActivate("DeathAnim")
			TActivate("PlayerDead_End")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="DeathAnim" active="0">
		<event timeout="0.23" eventid="GE_TIME_PERIOD" />
		<script>
			local Width = GetVar("DeathAnimWidth").AsInt
			local Height = GetVar("DeathAnimHeight").AsInt
			local PossibleEffects = StringToTable(GetVar("DeathAnimPossibleEffects").AsString)
			local EffectsAmount = GetVar("DeathAnimEffectsAmount").AsInt

			local DeathVar = GetVar("DeathAnim").AsInt
			local Plf = GetPlayerVehicle()
			local PlfCoor = Plf:GetPosition()
			PlfCoor.x = PlfCoor.x - math.random(Width) + math.random(Width)
			PlfCoor.y = PlfCoor.y - math.random(Height)/4 + math.random(Height)
			PlfCoor.z = PlfCoor.z - math.random(Width) + math.random(Width)
			
			CreateEffectTTLed(PossibleEffects[exrandom(getn(PossibleEffects))], PlfCoor, Quaternion(0.0000, 0.0000, 0.0000, 1.0000), 10000)

			DeathVar = DeathVar + 1
			SetVar("DeathAnim", DeathVar)

			if DeathVar >= EffectsAmount then
				SetVar("DeathAnim", 0)
				TActivate("DeathAnim_II")

				trigger:Deactivate()
			end

		</script>
	</trigger>

	<trigger Name="DeathAnim_II" active="0">
		<event timeout="1.13" eventid="GE_TIME_PERIOD" />
		<script>
			local Width = GetVar("DeathAnimWidth").AsInt
			local Height = GetVar("DeathAnimHeight").AsInt
			local PossibleEffects = StringToTable(GetVar("DeathAnimPossibleEffects_II").AsString)
			local EffectsAmount = GetVar("DeathAnimEffectsAmount").AsInt

			local DeathVar = GetVar("DeathAnim").AsInt
			local Plf = GetPlayerVehicle()
			local PlfCoor = Plf:GetPosition()
			PlfCoor.x = PlfCoor.x - math.random(Width) + math.random(Width)
			PlfCoor.y = PlfCoor.y - Height + math.random(Height)
			PlfCoor.z = PlfCoor.z - math.random(Width) + math.random(Width)
			
			CreateEffectTTLed(PossibleEffects[exrandom(getn(PossibleEffects))], PlfCoor, Quaternion(0.0000, 0.0000, 0.0000, 1.0000), 10000)

			DeathVar = DeathVar + 1
			SetVar("DeathAnim", DeathVar)

			if DeathVar >= EffectsAmount then
				trigger:Deactivate()
			end

		</script>
	</trigger>

	<trigger Name="PlayerDead_End" active="0">
		<event eventid="GE_END_CINEMATIC" ObjName="Player1" />
		<event eventid="GE_SKIP_CINEMATIC" ObjName="Player1" />
		<script>
			local AllEnemies = StringToTable(GetVar("Enemies").AsString)
			local Enemies = {AllEnemies[1],AllEnemies[2],AllEnemies[3],AllEnemies[4],AllEnemies[5],AllEnemies[6],AllEnemies[7],AllEnemies[8],AllEnemies[9],AllEnemies[10],AllEnemies[11],AllEnemies[12],AllEnemies[13],AllEnemies[14],AllEnemies[15],AllEnemies[16],AllEnemies[17],AllEnemies[18],AllEnemies[23],AllEnemies[24],AllEnemies[25],AllEnemies[26],AllEnemies[27],AllEnemies[28],AllEnemies[29],AllEnemies[30]}

			local FriendliesHealth = StringToTable(GetVar("FriendliesEndHealth").AsString)
			if not(CheckUnits(Enemies, "dead", 26)) then
				if not(IsQuestComplete("CD_PH01_EscortFirst")) then
					if CheckUnits("CDMerchant01_vehicle_0") then
						FriendliesHealth[3] = 0
						SetVar("FriendliesEndHealth", TableToString(FriendliesHealth))
					end

					FailQuest("CD_PH01_EscortFirst")
				end

				if not(IsQuestComplete("CD_PH01_EscortSecond")) then
					if CheckUnits("CDMerchant02_vehicle_0") then
						FriendliesHealth[4] = 0
						SetVar("FriendliesEndHealth", TableToString(FriendliesHealth))
					end

					FailQuest("CD_PH01_EscortSecond")
				end
			end

			if not(IsQuestTaken("CD_PH01_Retreat")) then
				FailQuest("CD_PH01")
			else
				FailQuest("CD_PH01_Retreat") -- the trigger is identical to Leave, besides this (FailQuest)
			end

			FailQuestIfTaken("CD_PH01_DestroyBoats")
			FailQuestIfTaken("CD_PH01_DestroyDestroyers")
			FailQuestIfTaken("CD_PH01_DestroyTurrets")
			FailQuestIfTaken("CD_PH01_DestroyCruisers")

			UpdateUnitsStats(1) -- the trigger is identical to Leave, besides this (1)

			CalcMissionStats(1) -- the trigger is identical to Leave, besides this (1)

			PassToMap("hq", "Headquarters_enter", 90, true)

			trigger:Deactivate()
		</script>
	</trigger>
</triggers>