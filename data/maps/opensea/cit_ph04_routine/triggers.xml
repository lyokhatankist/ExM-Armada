<?xml version="1.0" encoding="windows-1251" standalone="yes" ?>
<triggers>
	<trigger Name="GlobalVar" active="1">
		<event timeout="0" eventid="GE_TIME_PERIOD" />
		<script>
			g_ObjCont:SetGameTime( gMissionTime[1], gMissionTime[2], gMissionTime[3], gMissionTime[4], gMissionTime[5] )
			
			SetWeather(0)

			RuleConsole("cinematic_spring_coeff 0.3")

			ShowMap()

			Radar:SetScanRadius(750)

			GetPlayerVehicle():setImmortalMode(1)
			GetPlayerVehicle():SetNameFromScript("MyCar")
			SetCameraBehindPlayerVehicle()
			TActivate("PlayerDead")

			local friendly = {}
			local enemy = {}
			--                {objName                  Type               Prototype      EffHP VehHP FP Maneuv.      FriendlyName}
			friendly[1] = {"CITTorpedoBoat01_vehicle_0", "CITTorpedoBoatAegean", "CITPH04_FastboatCIT01", 39, 300, 729, 80, "ïîç. «Êëèí» (òèï «Ìþðåí»)"}
			friendly[2] = {"CITTorpedoBoat02_vehicle_0", "CITTorpedoBoatAegean", "CITPH04_FastboatCIT02", 39, 300, 729, 80, "ïîç. «Òóç» (òèï «Ìþðåí»)"}
			friendly[3] = {"CITTorpedoBoat01_vehicle_0", "CITTorpedoBoatAegean", "CITPH04_FastboatCIT03", 39, 300, 729, 80, "ïîç. «Äóõ» (òèï «Ìþðåí»)"}
			--                {objName      EffHP VehHP FP Maneuv.}
			enemy[1] = {"CDDestroyer01_vehicle_0", 1600, 1600, 6601, 22}
			enemy[2] = {"CDDestroyer01_vehicle_1", 1600, 1600, 6601, 22}
			enemy[3] = {"CDMerchant01_vehicle_0", 163, 1500, 0, 4}
			enemy[4] = {"CDMerchant02_vehicle_0", 163, 1500, 0, 4}
			enemy[5] = {"CDBoat01_vehicle_0", 46, 200, 265, 35}
			enemy[6] = {"CDBoat01_vehicle_1", 46, 200, 265, 35}
			enemy[7] = {"CDBoat01_vehicle_2", 46, 200, 265, 35}
			enemy[8] = {"CDBoat02_vehicle_0", 46, 200, 265, 35}
			enemy[9] = {"CDBoat02_vehicle_1", 46, 200, 265, 35}

			SetVar("MissionTime", 0)
			SetVar("RequiredMissionTime", 400) -- mission completion time (in s) for getting bonus score
			SetVar("BaseRetreatScore", 40) -- base retreat score that may get multiplied depending on 4 different factors
			SetVar("RequiredRetreatScore", 45) -- retreat score that needs to be reached for each friendly unit to successfully retreat
			SetVar("PlayerHealth", 39)
			SetVar("PlayerVehicleHealth", 300)
			SetVar("PlayerEndHealth", GetVar("PlayerHealth").AsInt)
			SetVar("PlayerName", "ïîç. «Êîðñàð» (òèï «Ìþðåí»)")
			SetVar("Objectives", 2) -- amount of main objectives, excluding destruction of all enemy units and completing the mission without losses
			SetVar("ObjectiveScoreReward", 3000) -- how much score each objective gives
			SetVar("MissionScoreRewardMultiplier", 0.85) -- multiplier that determines how much money the player will receive for each score point

			local j = 1
			local friendlies = {}
			while friendly[j] do
				friendlies[j] = friendly[j][1]
				j = j + 1
			end
			friendlies = TableToString(friendlies)
			j = 1
			local friendliesTypes = {}
			while friendly[j] do
				friendliesTypes[j] = friendly[j][2]
				j = j + 1
			end
			friendliesTypes = TableToString(friendliesTypes)
			j = 1
			local friendliesPrototypes = {}
			while friendly[j] do
				friendliesPrototypes[j] = friendly[j][3]
				j = j + 1
			end
			friendliesPrototypes = TableToString(friendliesPrototypes)
			j = 1
			local friendliesHealth = {}
			while friendly[j] do
				friendliesHealth[j] = friendly[j][4]
				j = j + 1
			end
			friendliesHealth = TableToString(friendliesHealth)
			j = 1
			local friendliesVehicleHealth = {}
			while friendly[j] do
				friendliesVehicleHealth[j] = friendly[j][5]
				j = j + 1
			end
			friendliesVehicleHealth = TableToString(friendliesVehicleHealth)
			j = 1
			local friendliesFirepower = {}
			while friendly[j] do
				friendliesFirepower[j] = friendly[j][6]
				j = j + 1
			end
			friendliesFirepower = TableToString(friendliesFirepower)
			j = 1
			local friendliesManeuverability = {}
			while friendly[j] do
				friendliesManeuverability[j] = friendly[j][7]
				j = j + 1
			end
			friendliesManeuverability = TableToString(friendliesManeuverability)
			j = 1
			local friendliesNames = {}
			while friendly[j] do
				friendliesNames[j] = friendly[j][8]
				j = j + 1
			end
			friendliesNames = TableToString(friendliesNames)

			j = 1
			local enemies = {}
			while enemy[j] do
				enemies[j] = enemy[j][1]
				j = j + 1
			end
			enemies = TableToString(enemies)
			j = 1
			local enemiesHealth = {}
			while enemy[j] do
				enemiesHealth[j] = enemy[j][2]
				j = j + 1
			end
			enemiesHealth = TableToString(enemiesHealth)
			j = 1
			local enemiesVehicleHealth = {}
			while enemy[j] do
				enemiesVehicleHealth[j] = enemy[j][3]
				j = j + 1
			end
			enemiesVehicleHealth = TableToString(enemiesVehicleHealth)
			j = 1
			local enemiesFirepower = {}
			while enemy[j] do
				enemiesFirepower[j] = enemy[j][4]
				j = j + 1
			end
			enemiesFirepower = TableToString(enemiesFirepower)
			j = 1
			local enemiesManeuverability = {}
			while enemy[j] do
				enemiesManeuverability[j] = enemy[j][5]
				j = j + 1
			end
			enemiesManeuverability = TableToString(enemiesManeuverability)
			SetVar("TotalMissionScore", 0) -- total score gained, gets updated after mission stats calculation with the info about destroyed enemy units; score for enemy units is decided by their firepower
			SetVar("ObjectivesCompleted", 0)
			SetVar("Friendlies", friendlies)
			SetVar("FriendliesTypes", friendliesTypes)
			SetVar("FriendliesPrototypes", friendliesPrototypes)
			SetVar("FriendliesHealth", friendliesHealth) -- friendlies effective hp
			SetVar("FriendliesVehicleHealth", friendliesVehicleHealth) -- friendlies real hp according to the vehicle stats, used in UpdateUnitsStats
			SetVar("FriendliesEndHealth", friendliesHealth) -- friendlies hp at the end of the mission, are updated by UpdateUnitsStats
			SetVar("FriendliesFirepower", friendliesFirepower)
			SetVar("FriendliesManeuverability", friendliesManeuverability)
			SetVar("FriendliesNames", friendliesNames)
			SetVar("Enemies", enemies)
			SetVar("EnemiesHealth", enemiesHealth) -- enemies effective hp
			SetVar("EnemiesVehicleHealth", enemiesVehicleHealth) -- enemies real hp according to the vehicle stats, used in UpdateUnitsStats
			SetVar("EnemiesEndHealth", enemiesHealth) -- enemies hp at the end of the mission, are updated by UpdateUnitsStats
			SetVar("EnemiesFirepower", enemiesFirepower)
			SetVar("EnemiesManeuverability", enemiesManeuverability)
			

			if not getObj("ThePendulum") then
				CreateVehicleEx("PendulumVehicle01", "ThePendulum", CVector(30, 255, 80), 1486)
				local Maschine = getObj("ThePendulum")
				if Maschine then
					Maschine:setGodMode(1)
					Maschine:setImmortalMode(1)
					Maschine:SetExternalPathByName("PendulumPath")
					
					TActivate("trPendulum")
				end
			end

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="trPendulum" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="ThePendulum" />
		<event eventid="GE_GAME_START" ObjName="Player1" />
		<script>
			local Maschine = GetEntityByName("ThePendulum")
			if Maschine then
				Maschine:SetLinearVelocity(CVector(0, 0, 0))
				Maschine:SetExternalPathByName("PendulumPath")
				local PendulumStat = GetVar("PendulumStatus").AsInt
				local MissionTime = GetVar("MissionTime").AsInt
				if 50>PendulumStat then
					PendulumStat = PendulumStat + 1
					SetVar("PendulumStatus", PendulumStat)
					println("pendstat set to "..PendulumStat)
					MissionTime = MissionTime + 8
					SetVar("MissionTime", MissionTime)
				else
					SetVar("PendulumStatus", 0)
					println("corovan management activated, pendstat set to 0")
					MissionTime = MissionTime + 8
					SetVar("MissionTime", MissionTime)
				end
			end

		</script>
	</trigger>

	<trigger Name="trMusicManager" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="ThePendulum" />
		<script>
			PlayMusic(GetVar("CustomMusicName").AsString)

		</script>
	</trigger>

	<trigger Name="MissionMusicStart" active="1">
		<event timeout="0.5" eventid="GE_TIME_PERIOD" />
		<script>
			PlayMusic("bs_stealth_quiet")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger	Name="NightvisionOff"	active="1">
		<event eventid="GE_PLAYER_VEHICLE_HORN" ObjName="Player1" />
		<script>
			RuleConsole("g_postEffect Nightvision_CIT")
			
			trigger:Deactivate()

			TActivate("NightvisionOn")
			
		</script>
	</trigger>

	<trigger	Name="NightvisionOn"	active="0">
		<event eventid="GE_PLAYER_VEHICLE_HORN" ObjName="Player1" />
		<script>
			RuleConsole("g_postEffect wNight_archipelago_clear")

			trigger:Deactivate()

			TActivate("NightvisionOff")

		</script>
	</trigger>

	<trigger Name="RetreatStart" active="0">
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="MissionStartLoc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Retreat01Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Retreat02Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Retreat03Loc" />
		<script>
			TActivate("Retreat")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Retreat" active="0">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="MissionStartLoc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Retreat01Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Retreat02Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Retreat03Loc" />
		<script>
			UpdateUnitsStats()

			local b = SpawnMessageBox( "1000" )
			if b == 1 then
				trigger:Deactivate()

				if not(IsQuestTaken("CIT_PH04_Retreat")) then
					FailQuest("CIT_PH04")
				else
					CompleteQuest("CIT_PH04_Retreat")
				end

				UpdateUnitsStats()

				CalcMissionStats()

				PassToMap("hq", "Headquarters_enter", 90, false )
			else
				trigger:Deactivate()

				TActivate("RetreatStart")
			end
			
		</script>
	</trigger>

	<trigger Name="Leave" active="0">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Leave01Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Leave02Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Leave03Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Leave04Loc" />
		<script>
			if not(IsQuestTaken("CIT_PH04_Retreat")) then
				FailQuest("CIT_PH04")
			else
				CompleteQuest("CIT_PH04_Retreat")
			end

			UpdateUnitsStats()

			CalcMissionStats()

			PassToMap("hq", "Headquarters_enter", 90, false)
			
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="WarningStart" active="0">
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning01Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning02Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning03Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning04Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning05Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning06Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning07Loc" />
		<script>
			TActivate("Warning")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Warning" active="1">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning01Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning02Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning03Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning04Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning05Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning06Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning07Loc" />
		<script>
			local b = SpawnMessageBox( "1002" )

			TActivate("WarningStart")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Desertion" active="1">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion01Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion02Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion03Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion04Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion05Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion06Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion07Loc" />
		<script>
			if not(IsQuestTaken("CIT_PH04_Retreat")) then
				FailQuest("CIT_PH04")
			else
				FailQuest("CIT_PH04_Retreat")
				FailQuest("CIT_PH04")
			end

			UpdateUnitsStats(1) -- the trigger is identical to Leave, besides this (1)

			CalcMissionStats(1) -- the trigger is identical to Leave, besides this (1)

			PassToMap("hq", "Headquarters_enter", 90, false)
			
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="MissionStart" active="1">
		<event timeout="0" eventid="GE_TIME_PERIOD" />
		<script>
			local Units
			local Unit
			-- ================
			--  Main CIT Force
			-- ================
			TeamCreate("CITTorpedoBoat01", 1002, CVector(6570, 275, 1565), {"CITPH04_FastboatCIT01", "CITPH04_FastboatCIT02"})
			TeamCreate("CITTorpedoBoat02", 1002, CVector(6560, 275, 1657), {"CITPH04_FastboatCIT03"})

			-- ----------------
			-- Units parameters

			Units = getObj("CITTorpedoBoat01")
			if Units then
				Units:SetProperty ("TeamTacticPrototype", "StandardTactic")
				Units:_AdjustBehaviour ()
			end

			Units = getObj("CITTorpedoBoat02")
			if Units then
				Units:SetProperty ("TeamTacticPrototype", "AssaultBottomTactic")
				Units:_AdjustBehaviour ()
			end

			-- ---------------
			-- Unit parameters

			Unit = getObj("CITTorpedoBoat01_vehicle_0")
			if Unit then
				Unit:SetRotation(Quaternion(0.0000, -0.3007, 0.0000, 0.9537))
				Unit:SetCruisingSpeed(15)
				Unit:SetExternalPathByName("StartPath_CITTorpedoBoat01")
			end

			Unit = getObj("CITTorpedoBoat01_vehicle_1")
			if Unit then
				Unit:SetGamePositionOnGround(CVector(6555, 275, 1544))
				Unit:SetRotation(Quaternion(0.0000, -0.3007, 0.0000, 0.9537))
				Unit:SetCruisingSpeed(15)
				Unit:SetExternalPathByName("StartPath_CITTorpedoBoat02")
			end

			Unit = getObj("CITTorpedoBoat02_vehicle_0")
			if Unit then
				Unit:SetRotation(Quaternion(0.0000, -0.3007, 0.0000, 0.9537))
				Unit:SetCruisingSpeed(15)
				Unit:SetExternalPathByName("StartPath_CITTorpedoBoat03")
			end

			-- ===============
			--  Main CD Force
			-- ===============
			TeamCreate("CDDestroyer01", 1053, CVector(5259, 279, 5774), {"CITPH04_DestroyerCD02", "CITPH04_DestroyerCD01"})
			CreateVehicleEx("CITPH04_MerchantCD01", "CDMerchant01_vehicle_0", CVector(5441, 279, 5932), 1051)
			CreateVehicleEx("CITPH04_MerchantCD01", "CDMerchant02_vehicle_0", CVector(5608, 279, 6211), 1051)
			TeamCreate("CDBoat01", 1052, CVector(5601, 279, 5986), {"CITPH04_SmlboatCD01", "CITPH04_SmlboatCD01", "CITPH04_SmlboatCD01"})
			TeamCreate("CDBoat02", 1052, CVector(5535, 279, 5907), {"CITPH04_SmlboatCD01", "CITPH04_SmlboatCD01"})

			-- =============
			--  CD Reserves
			-- =============

			-- ----------------
			-- Units parameters

			for i=1, 2 do
				Units = getObj("CDDestroyer0"..i)
				if Units then
					Units:SetProperty ("TeamTacticPrototype", "BoxTactic")
					Units:_AdjustBehaviour ()
				end
			end

	
			for i=1, 2 do
				Units = getObj("CDBoat0"..i)
				if Units then
					Units:SetProperty ("TeamTacticPrototype", "MeatTeamTactic")
					Units:_AdjustBehaviour ()
				end
			end

			-- ---------------
			-- Unit parameters
			
			Unit = getObj("CDDestroyer01_vehicle_0")
			if Unit then
				Unit:SetRotation(Quaternion(0.0000, -0.9659, 0.0000, 0.2588))
			end

			Unit = getObj("CDDestroyer01_vehicle_1")
			if Unit then
				Unit:SetGamePositionOnGround(CVector(5574, 279, 6036))
				Unit:SetRotation(Quaternion(0.0000, -0.9659, 0.0000, 0.2588))
			end

			Unit = getObj("CDMerchant01_vehicle_0")
			if Unit then
				Unit:SetRotation(Quaternion(0.0000, -0.9659, 0.0000, 0.2588))
			end

			Unit = getObj("CDMerchant02_vehicle_0")
			if Unit then
				Unit:SetRotation(Quaternion(0.0000, -0.9659, 0.0000, 0.2588))
			end

			local coords = {CVector(5601, 279, 5986), CVector(5483, 279, 6073), CVector(5526, 279, 6173)}
			for i=0, 2 do
				Unit = getObj("CDBoat01_vehicle_"..i)
				if Unit then
					Unit:SetGamePositionOnGround(coords[i+1])
					Unit:SetRotation(Quaternion(0.0000, -0.9659, 0.0000, 0.2588))
				end
			end

			coords = {CVector(5535, 279, 5907), CVector(5339, 279, 5963)}
			for i=0, 1 do
				Unit = getObj("CDBoat02_vehicle_"..i)
				if Unit then
					Unit:SetGamePositionOnGround(coords[i+1])
					Unit:SetRotation(Quaternion(0.0000, -0.9659, 0.0000, 0.2588))
				end
			end

			-- =========
			--  Trigger
			-- =========

			local PlfID = GetPlayerVehicleId()
			FlyLinked( "CITPH04_Start1", PlfID, 30, 0, 1, PlfID )
			StartCinematic()

			AddCinematicMessage( 1, 2)
			AddCinematicMessage( 2, 1)
			AddCinematicMessage( 3, 1)

			local Plf = GetPlayerVehicle()
			if Plf then
				Plf:SetRotation(Quaternion(0.0000, -0.3007, 0.0000, 0.9537))
				Plf:SetExternalPathByName("StartPath_Player")
				Plf:LimitMaxSpeed(16)
			end

			TActivate("MissionStart_End")
			
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="MissionStart_End" active="0">
		<event eventid="GE_END_CINEMATIC" ObjName="Player1" />
		<event eventid="GE_SKIP_CINEMATIC" ObjName="Player1" />
		<script>
			local Unit
			local Plf = GetPlayerVehicle()

			if Plf then
				Plf:PlaceToEndOfPath("StartPath_Player")
				Plf:UnlimitMaxSpeed()
				Plf:AddModifier("fuel", "+ 6271337")
			end

			Unit = getObj("CITTorpedoBoat01_vehicle_0")
			if Unit then
				Unit:PlaceToEndOfPath("StartPath_CITTorpedoBoat01")
				Unit:SetExternalPathByName("CITTorpedoBoat01_Waypoint1")
				Unit:SetCruisingSpeed(40)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CITTorpedoBoat01_vehicle_1")
			if Unit then
				Unit:PlaceToEndOfPath("StartPath_CITTorpedoBoat02")
				Unit:SetExternalPathByName("CITTorpedoBoat02_Waypoint1")
				Unit:SetCruisingSpeed(40)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CITTorpedoBoat02_vehicle_0")
			if Unit then
				Unit:PlaceToEndOfPath("StartPath_CITTorpedoBoat03")
				Unit:SetExternalPathByName("CITTorpedoBoat03_Waypoint1")
				Unit:SetCruisingSpeed(40)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CDBoat01_vehicle_0")
			if Unit then
				Unit:SetExternalPathByName("CDBoat01_Waypoint1")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CDBoat01_vehicle_1")
			if Unit then
				Unit:SetExternalPathByName("CDBoat02_Waypoint1")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CDBoat01_vehicle_2")
			if Unit then
				Unit:SetExternalPathByName("CDBoat03_Waypoint1")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CDBoat02_vehicle_0")
			if Unit then
				Unit:SetExternalPathByName("CDBoat04_Waypoint1")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CDBoat02_vehicle_1")
			if Unit then
				Unit:SetExternalPathByName("CDBoat05_Waypoint1")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CDDestroyer01_vehicle_0")
			if Unit then
				Unit:SetExternalPathByName("CDDestroyer01_Waypoint1")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CDDestroyer01_vehicle_1")
			if Unit then
				Unit:SetExternalPathByName("CDDestroyer02_Waypoint1")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CDMerchant01_vehicle_0")
			LOG(6271)
			if Unit then
				Unit:SetExternalPathByName("CDMerchant01_Waypoint1")
				LOG(6272)
				Unit:SetCruisingSpeed(3)
				LOG(6273)
			end

			Unit = getObj("CDMerchant02_vehicle_0")
			LOG(6274)
			if Unit then
				Unit:SetExternalPathByName("CDMerchant02_Waypoint1")
				LOG(6275)
				Unit:SetCruisingSpeed(3)
				LOG(6276)
			end

			TActivate("CDMerchantsTargetReached")
			TActivate("CDMerchantsDestroyed")
			TActivate("CDMerchantsFormationManager")
			TActivate("CDBoatsTargetReached")
			TActivate("CITOrder")
			TActivate("CITCriticalLosses")

			TActivate("RetreatStart")
			TActivate("Leave")

			TakeQuest("CIT_PH04")

			AddImportantFadingMsgByStrIdFormatted("fm_nightvision")

			SetVar("MissionTime", 0)

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="CDMerchantsTargetReached" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="CDMerchant01_vehicle_0" />
		<event eventid="GE_TARGET_REACHED" ObjName="CDMerchant02_vehicle_0" />
		<script>
			local Friendlies = StringToTable(GetVar("Friendlies").AsString)

			UpdateUnitsStats()

			FailQuest("CIT_PH04_DestroyMerchants")

			if not(IsQuestTaken("CIT_PH04_Retreat")) and not(IsQuestTaken("CIT_PH04_DestroyCruisers")) then
				AddImportantFadingMsgByStrIdFormatted("fm_cit_ph04_retreat")
			end

			if CheckUnits(Friendlies, "alive", 1) then
				TActivate("CITRetreat")

				AddFadingMsgId("fm_cit_ph04_citretreating")
			end

			TakeQuest("CIT_PH04_Retreat")

			TDeactivate("CDMerchantsFormationManager")

			trigger:Deactivate()

		</script>
	</trigger>

	<trigger Name="CDMerchantsDestroyed" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="ThePendulum" />
		<event eventid="GE_OBJECT_DIE" ObjName="CDMerchant01_vehicle_0" />
		<event eventid="GE_OBJECT_DIE" ObjName="CDMerchant02_vehicle_0" />
		<script>
			local Friendlies = StringToTable(GetVar("Friendlies").AsString)
			local Enemies = StringToTable(GetVar("Enemies").AsString)
			local TargetEnemies = {Enemies[3],Enemies[4]}

			if CheckUnits(TargetEnemies, "dead", 2) then
				UpdateUnitsStats()

				CompleteQuest("CIT_PH04_DestroyMerchants")

				if not(IsQuestTaken("CIT_PH04_Retreat")) then
					AddImportantFadingMsgByStrIdFormatted("fm_cit_ph04_retreat")
				end

				if CheckUnits(Friendlies, "alive", 1) then
					TActivate("CITRetreat")

					AddFadingMsgId("fm_cit_ph04_citretreating")
				end

				TakeQuest("CIT_PH04_Retreat")

				TDeactivate("CDMerchantsTargetReached")

				if CheckDistBetweenUnits(GetPlayerVehicle(), Enemies, "least") >= 950 then
					local b = SpawnMessageBox( "1001" )
					println("mission end 0")
					if b == 1 then
						trigger:Deactivate()

						CompleteQuestIfTaken("CIT_PH04_Retreat")

						println("mission end 1")

						UpdateUnitsStats()

						CalcMissionStats()

						println("mission end 3")

						PassToMap("hq", "Headquarters_enter", 90, false )
					end
				end

				trigger:Deactivate()
			else
				UpdateQuestCoordinates("CIT_PH04_DestroyMerchants", TargetEnemies)
			end

		</script>
	</trigger>

	<trigger Name="CDMerchantsFormationManager" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="ThePendulum" />
		<script>
			local CDB01a = getObj("CDBoat01_vehicle_0")
			local CDB01b = getObj("CDBoat01_vehicle_1")
			local CDB01c = getObj("CDBoat01_vehicle_2")
			local CDB02a = getObj("CDBoat02_vehicle_0")
			local CDB02b = getObj("CDBoat02_vehicle_1")
			local CDD01a = getObj("CDDestroyer01_vehicle_0")
			local CDD01b = getObj("CDDestroyer01_vehicle_1")
			local CDM01a = getObj("CDMerchant01_vehicle_0")
			local CDM02a = getObj("CDMerchant02_vehicle_0")

			if CheckUnits("CDMerchant01_vehicle_0") or CheckUnits("CDMerchant02_vehicle_0") then
				if CDB01a then
					CDB01a:SetCruisingSpeed(3)
				end

				if CDB01b then
					CDB01b:SetCruisingSpeed(3)
				end

				if CDB01c then
					CDB01c:SetCruisingSpeed(3)
				end

				if CDB02a then
					CDB02a:SetCruisingSpeed(3)
				end

				if CDB02b then
					CDB02b:SetCruisingSpeed(3)
				end

				if CDD01a then
					CDD01a:SetCruisingSpeed(3)
				end

				if CDD01b then
					CDD01b:SetCruisingSpeed(3)
				end

				if CDM01a then
					CDM01a:SetCruisingSpeed(3)
				end

				if CDM02a then
					CDM02a:SetCruisingSpeed(3)
				end
			else
				if CDB01a then
					CDB01a:SetCruisingSpeed(40)
				end

				if CDB01b then
					CDB01b:SetCruisingSpeed(40)
				end

				if CDB01c then
					CDB01c:SetCruisingSpeed(40)
				end

				if CDB02a then
					CDB02a:SetCruisingSpeed(40)
				end

				if CDB02b then
					CDB02b:SetCruisingSpeed(40)
				end

				if CDD01a then
					CDD01a:SetCruisingSpeed(40)
				end

				if CDD01b then
					CDD01b:SetCruisingSpeed(40)
				end

				LOG("CD MERCHANT FORMATION MANAGER DISABLED BY ITSELF")

				trigger:Deactivate()
			end

		</script>
	</trigger>

	<trigger Name="CDBoatsTargetReached" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="CDBoat01_vehicle_2" />
		<event eventid="GE_TARGET_REACHED" ObjName="CDBoat02_vehicle_1" />
		<script>
			local Unit

			UpdateUnitsStats()

			Unit = getObj("CDBoat01_vehicle_0")
			if Unit then
				Unit:SetExternalPathByName("CDBoat01_Waypoint2")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CDBoat01_vehicle_1")
			if Unit then
				Unit:SetExternalPathByName("CDBoat02_Waypoint2")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CDBoat01_vehicle_2")
			if Unit then
				Unit:SetExternalPathByName("CDBoat03_Waypoint2")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CDBoat02_vehicle_0")
			if Unit then
				Unit:SetExternalPathByName("CDBoat04_Waypoint2")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CDBoat02_vehicle_1")
			if Unit then
				Unit:SetExternalPathByName("CDBoat05_Waypoint2")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="CITOrder" active="0">
		<event eventid="GE_UNDER_ATTACK" ObjName="CDMerchant01_vehicle_0" />
		<event eventid="GE_UNDER_ATTACK" ObjName="CDMerchant02_vehicle_0" />
		<event eventid="GE_NOTICE_ENEMY" ObjName="CDDestroyer01_vehicle_0" />
		<event eventid="GE_NOTICE_ENEMY" ObjName="CDDestroyer01_vehicle_1" />
		<event eventid="GE_NOTICE_ENEMY" ObjName="CDBoat01_vehicle_0" />
		<event eventid="GE_NOTICE_ENEMY" ObjName="CDBoat02_vehicle_0" />
		<script>
			local Units
			local MerchantsPos

			if CheckUnits("CDMerchant01_vehicle_0") then
				MerchantsPos = getObj("CDMerchant01_vehicle_0"):GetPosition()
			elseif CheckUnits("CDMerchant02_vehicle_0") then
				MerchantsPos = getObj("CDMerchant02_vehicle_0"):GetPosition()
			else
				MerchantsPos = CVector(4385, 255, 4175)
			end

			UpdateUnitsStats()

			Units = getObj("CITTorpedoBoat01")
			if Units then
				Units:StackOpen()
				Units:SetDestination(MerchantsPos)
				Units:SetDestination(CVector(3273, 255, 2139))
				Units:StackClose()
			end

			Units = getObj("CITTorpedoBoat02")
			if Units then
				Units:StackOpen()
				Units:SetDestination(MerchantsPos)
				Units:SetDestination(CVector(3273, 255, 2139))
				Units:StackClose()
			end

			AddImportantFadingMsgByStrIdFormatted("fm_cit_ph04_order")

			PlayMusic("bs_stealth_combat")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="CITCriticalLosses" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="ThePendulum" />
		<event eventid="GE_OBJECT_DIE" ObjName="CITTorpedoBoat01_vehicle_0" />
		<event eventid="GE_OBJECT_DIE" ObjName="CITTorpedoBoat01_vehicle_1" />
		<event eventid="GE_OBJECT_DIE" ObjName="CITTorpedoBoat02_vehicle_0" />
		<script>
			local Friendlies = StringToTable(GetVar("Friendlies").AsString)
			local FriendliesHealth = StringToTable(GetVar("FriendliesEndHealth").AsString)
			local PlayerHealth = StringToTable(GetVar("PlayerEndHealth").AsString)
			local TotalHealth = FriendliesHealth[1] + FriendliesHealth[2] + FriendliesHealth[3] + PlayerHealth

			if CheckUnits(Friendlies, "dead", 2) or 48 >= TotalHealth then
				UpdateUnitsStats()
				
				AddFadingMsgId("fm_critical_loss_ally")

				TActivate("CITRetreat")

				trigger:Deactivate()
			end
			
		</script>
	</trigger>

	<trigger Name="CITRetreat" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="ThePendulum" />
		<script>
			local Unit
			local Friendlies = StringToTable(GetVar("Friendlies").AsString)
			local RetreatMusic = GetVar("RetreatMusic").AsInt

			if RetreatMusic == -1 then
				Unit = getObj("CITTorpedoBoat01")
				if Unit then
					Unit:SetProperty ("TeamTacticPrototype", "CowardTeamTactic")
					Unit:_AdjustBehaviour ()
				end
				Unit = getObj("CITTorpedoBoat02")
				if Unit then
					Unit:SetProperty ("TeamTacticPrototype", "CowardTeamTactic")
					Unit:_AdjustBehaviour ()
				end

				for i=1,3 do
					Unit = getObj(Friendlies[i])
					if Unit then
						Unit:SetExternalPathByName("CITRetreatDirection_"..i)
						Unit:SetCanBeDistractedFromMoving(false)
						Unit:SetCruisingSpeed(40)
					end
				end

				AddImportantFadingMsgByStrIdFormatted("fm_retreat_attempt_ally")
			elseif RetreatMusic >= 2 then
				PlayMusic("bs_stealth_retreat")

				trigger:Deactivate()
			else
				RetreatMusic = RetreatMusic + 1

				SetVar("RetreatMusic", RetreatMusic)
			end

		</script>
	</trigger>
</triggers>