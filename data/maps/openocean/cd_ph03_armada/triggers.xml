<?xml version="1.0" encoding="windows-1251" standalone="yes" ?>
<triggers>
	<trigger Name="GlobalVar" active="1">
		<event timeout="0" eventid="GE_TIME_PERIOD" />
		<script>
			g_ObjCont:SetGameTime( gMissionTime[1], gMissionTime[2], gMissionTime[3], gMissionTime[4], gMissionTime[5] )
			
			SetWeather(0)

			RuleConsole("cinematic_spring_coeff 0.3")

			ShowMap()

			Radar:SetScanRadius(1200)

			GetPlayerVehicle():setImmortalMode(1)
			GetPlayerVehicle():SetNameFromScript("MyCar")
			SetCameraBehindPlayerVehicle()
			TActivate("PlayerDead")

			local friendly = {}
			local enemy = {}
			--                {objName                  Type               Prototype      EffHP VehHP FP Maneuv.      FriendlyName}
			friendly[1] = {"CDRocketHeavyCruiser01_vehicle_0", "CDRocketHeavyCruiserAtlantic", "CDPH03_RHCruiserCD01", 4500, 4500, 96096, 12, "«Аргументо» (тип «Тоскана»)"}
			friendly[2] = {"CDDestroyer01_vehicle_0", "CDDestroyerAtlantic", "CDPH03_DestroyerCD01", 1600, 1600, 9180, 22, "«Агирре» (тип «Альбедо»)"}
			friendly[3] = {"CDDestroyer01_vehicle_1", "CDDestroyerAtlantic", "CDPH03_DestroyerCD02", 1600, 1600, 9256, 22, "«Андорра» (тип «Альбедо»)"}
--			friendly[4] = {"CDDestroyer01_vehicle_2", "CDDestroyerAtlantic", "CDPH03_DestroyerCD03", 1600, 1600, 9180, 22, "«Эсперанса» (э.м.т. «Альбедо»)"}
			--                {objName      EffHP VehHP FP Maneuv.}
			enemy[1] = {"CITBattleship01_vehicle_0", 9000, 9000, 43002, 5}
			enemy[2] = {"CITOldCruiser01_vehicle_0", 1600, 1600, 10967, 20}
			enemy[3] = {"CITOldCruiser01_vehicle_1", 1600, 1600, 10967, 20}
			enemy[4] = {"CITOldCruiser01_vehicle_2", 1600, 1600, 10967, 20}
			enemy[5] = {"CITDestroyer01_vehicle_0", 1200, 1200, 9524, 26}
			enemy[6] = {"CITDestroyer01_vehicle_1", 1200, 1200, 9524, 26}
			enemy[7] = {"CITHelicopter01_vehicle_0", 20, 500, 2864, 110}
			enemy[8] = {"CITHelicopter01_vehicle_1", 20, 500, 2864, 110}
			enemy[9] = {"CITHelicopter02_vehicle_0", 20, 500, 2864, 110}
			enemy[10] = {"CITHelicopter02_vehicle_1", 20, 500, 2864, 110}
			enemy[11] = {"CITHelicopter03_vehicle_0", 20, 500, 2864, 110}
			enemy[12] = {"CITHelicopter03_vehicle_1", 20, 500, 2864, 110}
			enemy[13] = {"CITHelicopter04_vehicle_0", 20, 500, 2864, 110}
			enemy[14] = {"CITHelicopter04_vehicle_1", 20, 500, 2864, 110}
			enemy[15] = {"CITHelicopter05_vehicle_0", 20, 500, 2864, 110}
			enemy[16] = {"CITHelicopter05_vehicle_1", 20, 500, 2864, 110}
			if HardMode~=nil then
				enemy[17] = {"CITHelicopter06_vehicle_0", 20, 500, 2864, 110}
				enemy[18] = {"CITHelicopter06_vehicle_1", 20, 500, 2864, 110}
				enemy[19] = {"CITHelicopter07_vehicle_0", 20, 500, 2864, 110}
				enemy[20] = {"CITHelicopter07_vehicle_1", 20, 500, 2864, 110}
				enemy[21] = {"CITHelicopter08_vehicle_0", 20, 500, 2864, 110}
				enemy[22] = {"CITHelicopter08_vehicle_1", 20, 500, 2864, 110}
			end
--			enemy[23] = {"CITDestroyer01_vehicle_2", 1200, 1200, 9524, 26}
--			enemy[24] = {"CITDestroyer01_vehicle_3", 1200, 1200, 9524, 26}

			SetVar("MissionTime", 0)
			SetVar("RequiredMissionTime", 440) -- mission completion time (in s) for getting bonus score
			SetVar("BaseRetreatScore", 40) -- base retreat score that may get multiplied depending on 4 different factors
			SetVar("RequiredRetreatScore", 45) -- retreat score that needs to be reached for each friendly unit to successfully retreat
			SetVar("PlayerHealth", 6000)
			SetVar("PlayerVehicleHealth", 6000)
			SetVar("PlayerEndHealth", GetVar("PlayerHealth").AsInt)
			SetVar("PlayerName", "«Сарагоса» (тип «Левиафан»)")
			SetVar("Objectives", 2) -- amount of main objectives, excluding destruction of all enemy units and completing the mission without losses
			SetVar("ObjectiveScoreReward", 30000) -- how much score each objective gives
			SetVar("MissionScoreRewardMultiplier", 0.165) -- multiplier that determines how much money the player will receive for each score point

			local j = 1
			local friendlies = {}
			while friendly[j] do
				friendlies[j] = friendly[j][1]
				j = j + 1
			end
			friendlies = TableToString(friendlies)
			j = 1
			local friendliesTypes = {}
			while friendly[j] do
				friendliesTypes[j] = friendly[j][2]
				j = j + 1
			end
			friendliesTypes = TableToString(friendliesTypes)
			j = 1
			local friendliesPrototypes = {}
			while friendly[j] do
				friendliesPrototypes[j] = friendly[j][3]
				j = j + 1
			end
			friendliesPrototypes = TableToString(friendliesPrototypes)
			j = 1
			local friendliesHealth = {}
			while friendly[j] do
				friendliesHealth[j] = friendly[j][4]
				j = j + 1
			end
			friendliesHealth = TableToString(friendliesHealth)
			j = 1
			local friendliesVehicleHealth = {}
			while friendly[j] do
				friendliesVehicleHealth[j] = friendly[j][5]
				j = j + 1
			end
			friendliesVehicleHealth = TableToString(friendliesVehicleHealth)
			j = 1
			local friendliesFirepower = {}
			while friendly[j] do
				friendliesFirepower[j] = friendly[j][6]
				j = j + 1
			end
			friendliesFirepower = TableToString(friendliesFirepower)
			j = 1
			local friendliesManeuverability = {}
			while friendly[j] do
				friendliesManeuverability[j] = friendly[j][7]
				j = j + 1
			end
			friendliesManeuverability = TableToString(friendliesManeuverability)
			j = 1
			local friendliesNames = {}
			while friendly[j] do
				friendliesNames[j] = friendly[j][8]
				j = j + 1
			end
			friendliesNames = TableToString(friendliesNames)

			j = 1
			local enemies = {}
			while enemy[j] do
				enemies[j] = enemy[j][1]
				j = j + 1
			end
			enemies = TableToString(enemies)
			j = 1
			local enemiesHealth = {}
			while enemy[j] do
				enemiesHealth[j] = enemy[j][2]
				j = j + 1
			end
			enemiesHealth = TableToString(enemiesHealth)
			j = 1
			local enemiesVehicleHealth = {}
			while enemy[j] do
				enemiesVehicleHealth[j] = enemy[j][3]
				j = j + 1
			end
			enemiesVehicleHealth = TableToString(enemiesVehicleHealth)
			j = 1
			local enemiesFirepower = {}
			while enemy[j] do
				enemiesFirepower[j] = enemy[j][4]
				j = j + 1
			end
			enemiesFirepower = TableToString(enemiesFirepower)
			j = 1
			local enemiesManeuverability = {}
			while enemy[j] do
				enemiesManeuverability[j] = enemy[j][5]
				j = j + 1
			end
			enemiesManeuverability = TableToString(enemiesManeuverability)
			SetVar("TotalMissionScore", 0) -- total score gained, gets updated after mission stats calculation with the info about destroyed enemy units; score for enemy units is decided by their firepower
			SetVar("ObjectivesCompleted", 0)
			SetVar("Friendlies", friendlies)
			SetVar("FriendliesTypes", friendliesTypes)
			SetVar("FriendliesPrototypes", friendliesPrototypes)
			SetVar("FriendliesHealth", friendliesHealth) -- friendlies effective hp
			SetVar("FriendliesVehicleHealth", friendliesVehicleHealth) -- friendlies real hp according to the vehicle stats, used in UpdateUnitsStats
			SetVar("FriendliesEndHealth", friendliesHealth) -- friendlies hp at the end of the mission, are updated by UpdateUnitsStats
			SetVar("FriendliesFirepower", friendliesFirepower)
			SetVar("FriendliesManeuverability", friendliesManeuverability)
			SetVar("FriendliesNames", friendliesNames)
			SetVar("Enemies", enemies)
			SetVar("EnemiesHealth", enemiesHealth) -- enemies effective hp
			SetVar("EnemiesVehicleHealth", enemiesVehicleHealth) -- enemies real hp according to the vehicle stats, used in UpdateUnitsStats
			SetVar("EnemiesEndHealth", enemiesHealth) -- enemies hp at the end of the mission, are updated by UpdateUnitsStats
			SetVar("EnemiesFirepower", enemiesFirepower)
			SetVar("EnemiesManeuverability", enemiesManeuverability)
			

			if not getObj("ThePendulum") then
				CreateVehicleEx("PendulumVehicle01", "ThePendulum", CVector(30, 255, 80), 1486)
				local Maschine = getObj("ThePendulum")
				if Maschine then
					Maschine:setGodMode(1)
					Maschine:setImmortalMode(1)
					Maschine:SetExternalPathByName("PendulumPath")
					
					TActivate("trPendulum")
				end
			end

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="trPendulum" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="ThePendulum" />
		<event eventid="GE_GAME_START" ObjName="Player1" />
		<script>
			local Maschine = GetEntityByName("ThePendulum")
			if Maschine then
				Maschine:SetLinearVelocity(CVector(0, 0, 0))
				Maschine:SetExternalPathByName("PendulumPath")
				local PendulumStat = GetVar("PendulumStatus").AsInt
				local MissionTime = GetVar("MissionTime").AsInt
				if 50>PendulumStat then
					PendulumStat = PendulumStat + 1
					SetVar("PendulumStatus", PendulumStat)
					println("pendstat set to "..PendulumStat)
					MissionTime = MissionTime + 8
					SetVar("MissionTime", MissionTime)
				else
					SetVar("PendulumStatus", 0)
					println("corovan management activated, pendstat set to 0")
					MissionTime = MissionTime + 8
					SetVar("MissionTime", MissionTime)
				end
			end

		</script>
	</trigger>

	<trigger Name="trMusicManager" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="ThePendulum" />
		<script>
			PlayMusic(GetVar("CustomMusicName").AsString)

		</script>
	</trigger>

	<trigger Name="MissionMusicStart" active="1">
		<event timeout="0.5" eventid="GE_TIME_PERIOD" />
		<script>
			PlayMusic("bs_armada_quiet")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="RetreatStart" active="0">
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="MissionStartLoc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Retreat01Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Retreat02Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Retreat03Loc" />
		<script>
			TActivate("Retreat")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Retreat" active="0">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="MissionStartLoc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Retreat01Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Retreat02Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Retreat03Loc" />
		<script>
			UpdateUnitsStats()

			local b = SpawnMessageBox( "1000" )
			if b == 1 then
				trigger:Deactivate()

				if not(IsQuestTaken("CD_PH03_Retreat")) then
					FailQuest("CD_PH03")
					FailQuestIfTaken("CD_PH03_ProtectCruiser")
				else
					FailQuestIfTaken("CD_PH03_DestroyBattleship")
					CompleteQuest("CD_PH03_Retreat")
					FailQuestIfTaken("CD_PH03_ProtectCruiser")
				end

				UpdateUnitsStats()

				CalcMissionStats()

				PassToMap("hq", "Headquarters_enter", 90, false )
			else
				trigger:Deactivate()

				TActivate("RetreatStart")
			end
			
		</script>
	</trigger>

	<trigger Name="Leave" active="0">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Leave01Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Leave02Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Leave03Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Leave04Loc" />
		<script>
			if not(IsQuestTaken("CD_PH03_Retreat")) then
				FailQuest("CD_PH03")
				FailQuestIfTaken("CD_PH03_ProtectCruiser")
			else
				FailQuestIfTaken("CD_PH03_DestroyBattleship")
				CompleteQuest("CD_PH03_Retreat")
				FailQuestIfTaken("CD_PH03_ProtectCruiser")
			end

			UpdateUnitsStats()

			CalcMissionStats()

			PassToMap("hq", "Headquarters_enter", 90, false)
			
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="WarningStart" active="0">
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning01Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning02Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning03Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning04Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning05Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning06Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning07Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning08Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning09Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning10Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning11Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning12Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning13Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning14Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning15Loc" />
		<script>
			TActivate("Warning")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Warning" active="1">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning01Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning02Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning03Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning04Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning05Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning06Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning07Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning08Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning09Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning10Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning11Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning12Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning13Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning14Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning15Loc" />
		<script>
			local b = SpawnMessageBox( "1002" )

			TActivate("WarningStart")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Desertion" active="1">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion01Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion02Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion03Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion04Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion05Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion06Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion07Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion08Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion09Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion10Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion11Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion12Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion13Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion14Loc" />
		<script>
			if not(IsQuestTaken("CD_PH03_Retreat")) then
				FailQuest("CD_PH03")
				FailQuestIfTaken("CD_PH03_ProtectCruiser")
			else
				FailQuest("CD_PH03_Retreat")
				FailQuest("CD_PH03")
				FailQuestIfTaken("CD_PH03_ProtectCruiser")
			end

			UpdateUnitsStats(1) -- the trigger is identical to Leave, besides this (1)

			CalcMissionStats(1) -- the trigger is identical to Leave, besides this (1)

			PassToMap("hq", "Headquarters_enter", 90, false)
			
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="MissionStart" active="1">
		<event timeout="0" eventid="GE_TIME_PERIOD" />
		<script>
			local Units
			local Unit
			local coords
			-- ================
			--  Main CD Force
			-- ================
			TeamCreate("CDRocketHeavyCruiser01", 1054, CVector(3136, 285, 3709), {"CDPH03_RHCruiserCD01"})
			TeamCreate("CDDestroyer01", 1053, CVector(3067, 285, 4070), {"CDPH03_DestroyerCD01", "CDPH03_DestroyerCD02"})

			-- ----------------
			-- Units parameters

			Units = getObj("CDRocketHeavyCruiser01")
			if Units then
				Units:SetProperty ("TeamTacticPrototype", "SniperTactic")
				Units:_AdjustBehaviour ()
			end

			Units = getObj("CDDestroyer01")
			if Units then
				Units:SetProperty ("TeamTacticPrototype", "StandardTactic")
				Units:_AdjustBehaviour ()
			end

			-- ---------------
			-- Unit parameters

			Unit = getObj("CDRocketHeavyCruiser01_vehicle_0")
			if Unit then
				Unit:SetRotation(Quaternion(0.0000, 0.2588, 0.0000, 0.9659))
				Unit:SetCruisingSpeed(4)
				Unit:SetExternalPathByName("StartPath_CDRocketHeavyCruiser01_vehicle_0")
			end

			coords = {CVector(3067, 285, 4070), CVector(2979, 285, 3848), CVector(3089, 285, 3932)}
			for i=0, 2 do
				Unit = getObj("CDDestroyer01_vehicle_"..i)
				if Unit then
					Unit:SetGamePositionOnGround(coords[i+1])
					Unit:SetRotation(Quaternion(0.0000, 0.2588, 0.0000, 0.9659))
					Unit:SetCruisingSpeed(4)
					Unit:SetExternalPathByName("StartPath_CDDestroyer01_vehicle_"..i)
				end
			end

			-- ===============
			--  Main CIT Force
			-- ===============
			TeamCreate("CITBattleship01", 1005, CVector(4102, 279, 6988), {"CDPH03_BattleshipCIT01"})
			TeamCreate("CITOldCruiser01", 1004, CVector(4057, 279, 6793), {"CDPH03_OCruiserCIT01", "CDPH03_OCruiserCIT01", "CDPH03_OCruiserCIT01"})
			TeamCreate("CITDestroyer01", 1003, CVector(4027, 279, 6882), {"CDPH03_DestroyerCIT01", "CDPH03_DestroyerCIT01"})

			TeamCreate("CITHelicopter01", 1003, CVector(5739, 279, 5446), {"CDPH03_HeliCIT0"..math.random(4), "CDPH03_HeliCIT0"..math.random(4)})
			TeamCreate("CITHelicopter02", 1003, CVector(5777, 279, 5609), {"CDPH03_HeliCIT0"..math.random(4), "CDPH03_HeliCIT0"..math.random(4)})
			TeamCreate("CITHelicopter03", 1003, CVector(6128, 279, 5431), {"CDPH03_HeliCIT0"..math.random(4), "CDPH03_HeliCIT0"..math.random(4)})
			TeamCreate("CITHelicopter04", 1003, CVector(6112, 279, 5532), {"CDPH03_HeliCIT0"..math.random(4), "CDPH03_HeliCIT0"..math.random(4)})
			TeamCreate("CITHelicopter05", 1003, CVector(6661, 279, 5478), {"CDPH03_HeliCIT0"..math.random(4), "CDPH03_HeliCIT0"..math.random(4)})
			if HardMode~=nil then
				TeamCreate("CITHelicopter06", 1003, CVector(6698, 279, 5573), {"CDPH03_HeliCIT0"..math.random(4), "CDPH03_HeliCIT0"..math.random(4)})
				TeamCreate("CITHelicopter07", 1003, CVector(6732, 279, 5678), {"CDPH03_HeliCIT0"..math.random(4), "CDPH03_HeliCIT0"..math.random(4)})
				TeamCreate("CITHelicopter08", 1003, CVector(6689, 279, 5798), {"CDPH03_HeliCIT0"..math.random(4), "CDPH03_HeliCIT0"..math.random(4)})
			end
			
			-- =============
			--  CIT Reserves
			-- =============

			-- ----------------
			-- Units parameters

			Units = getObj("CITBattleship01")
			if Units then
				Units:SetProperty ("TeamTacticPrototype", "SniperTactic")
				Units:_AdjustBehaviour ()
			end

			Units = getObj("CITOldCruiser01")
			if Units then
				Units:SetProperty ("TeamTacticPrototype", "CautiousTactic")
				Units:_AdjustBehaviour ()
			end

			Units = getObj("CITDestroyer01")
			if Units then
				Units:SetProperty ("TeamTacticPrototype", "StandardTactic")
				Units:_AdjustBehaviour ()
			end

			for i=1,8 do
				Units = getObj("CITHelicopter0"..i)
				if Units then
					Units:SetProperty ("TeamTacticPrototype", "StandardTactic")
					Units:_AdjustBehaviour ()
				end
			end

			-- ---------------
			-- Unit parameters
			
			Unit = getObj("CITBattleship01_vehicle_0")
			if Unit then
				Unit:SetRotation(Quaternion(0.0000, 0.9936, 0.0000, -0.1132))
			end

			coords = {CVector(4057, 279, 6793), CVector(4028, 279, 7108), CVector(4222, 279, 7063)}
			for i=0, 2 do
				Unit = getObj("CITOldCruiser01_vehicle_"..i)
				if Unit then
					Unit:SetGamePositionOnGround(coords[i+1])
					Unit:SetRotation(Quaternion(0.0000, 0.9936, 0.0000, -0.1132))
				end
			end

			coords = {CVector(4027, 279, 6882), CVector(4124, 279, 6860), CVector(3956, 279, 7022), CVector(4249, 279, 6954)}
			for i=0, 3 do
				Unit = getObj("CITDestroyer01_vehicle_"..i)
				if Unit then
					Unit:SetGamePositionOnGround(coords[i+1])
					Unit:SetRotation(Quaternion(0.0000, 0.9936, 0.0000, -0.1132))
				end
			end

			coords = {
				{CVector(5739, 279, 5446), CVector(5820, 279, 5441)},
				{CVector(5777, 279, 5609), CVector(5858, 279, 5604)},
				{CVector(6128, 279, 5431), CVector(6210, 279, 5426)},
				{CVector(6112, 279, 5532), CVector(6194, 279, 5528)},
				{CVector(6661, 279, 5478), CVector(6743, 279, 5474)},
				{CVector(6698, 279, 5573), CVector(6780, 279, 5569)},
				{CVector(6732, 279, 5678), CVector(6813, 279, 5673)},
				{CVector(6689, 279, 5798), CVector(6771, 279, 5793)}
					}
			for i=1, 8 do
				for j=0, 1 do
					Units = "CITHelicopter0"..i.."_vehicle_"..j
					LOG(Units)
					Unit = getObj(Units)
					if Unit then
						Unit:SetGamePositionOnGround(coords[i][j+1])
						Unit:SetRotation(Quaternion(0.0000, -0.7071, 0.0000, 0.7071))
						LOG("all set")
					end
				end
			end

			-- =========
			--  Trigger
			-- =========

			local PlfID = GetPlayerVehicleId()
			FlyLinked( "CDPH03_Start1", PlfID, 30, 0, 1, PlfID )
			StartCinematic()

			AddCinematicMessage( 1, 2)
			AddCinematicMessage( 2, 1)
			AddCinematicMessage( 3, 1)

			local Plf = GetPlayerVehicle()
			if Plf then
				Plf:SetRotation(Quaternion(0.0000, 0.2588, 0.0000, 0.9659))
				Plf:SetExternalPathByName("StartPath_Player")
				Plf:LimitMaxSpeed(4)
			end

			TActivate("MissionStart_End")
			
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="MissionStart_End" active="0">
		<event eventid="GE_END_CINEMATIC" ObjName="Player1" />
		<event eventid="GE_SKIP_CINEMATIC" ObjName="Player1" />
		<script>
			local Unit
			local Plf = GetPlayerVehicle()

			if Plf then
				Plf:PlaceToEndOfPath("StartPath_Player")
				Plf:UnlimitMaxSpeed()
				Plf:AddModifier("fuel", "+ 6271337")
				Plf:AddModifier("fuel", "- 1131")
			end

			Unit = getObj("CDRocketHeavyCruiser01_vehicle_0")
			if Unit then
				Unit:PlaceToEndOfPath("StartPath_CDRocketHeavyCruiser01_vehicle_0")
				Unit:SetExternalPathByName("CDRocketHeavyCruiser01_vehicle_0_Waypoint1")
				Unit:SetCruisingSpeed(5)
				Unit:SetCanBeDistractedFromMoving(false)
			end

			for i=0, 2 do
				Unit = getObj("CDDestroyer01_vehicle_"..i)
				if Unit then
					Unit:PlaceToEndOfPath("StartPath_CDDestroyer01_vehicle_"..i)
					Unit:SetExternalPathByName("CDDestroyer01_vehicle_"..i.."_Waypoint1")
					Unit:SetCruisingSpeed(5)
					if i~=1 then
						Unit:SetCanBeDistractedFromMoving(false)
					else
						Unit:SetCanBeDistractedFromMoving(true)
					end
				end
			end

			Unit = getObj("CITBattleship01_vehicle_0")
			if Unit then
				Unit:SetExternalPathByName("CITBattleship01_vehicle_0_Waypoint1")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			for i=0, 2 do
				Unit = getObj("CITOldCruiser01_vehicle_"..i)
				if Unit then
					Unit:SetExternalPathByName("CITOldCruiser01_vehicle_"..i.."_Waypoint1")
					Unit:SetCruisingSpeed(3)
					Unit:SetCanBeDistractedFromMoving(true)
				end
			end

			for i=0, 3 do
				Unit = getObj("CITDestroyer01_vehicle_"..i)
				if Unit then
					Unit:SetExternalPathByName("CITDestroyer01_vehicle_"..i.."_Waypoint1")
					Unit:SetCruisingSpeed(3)
					Unit:SetCanBeDistractedFromMoving(true)
				end
			end

			for i=1, 8 do
				Unit = getObj("CITHelicopter0"..i)
				if Unit then
					Unit:StackOpen()
					Unit:SetDestination(CVector(3857, 279, 4982))
					Unit:SetDestination(CVector(4204, 279, 6265))
					Unit:StackClose()
				end
			end

			TActivate("CITBattleshipDestroyed")
			TActivate("CITFormationManager")
			TActivate("CITCriticalLosses")
			TActivate("CDRocketHeavyCruiserDestroyed")
			TActivate("CDFormationManager")
			TActivate("CDOrder")
			TActivate("CDCriticalLosses")

			TActivate("RetreatStart")
			TActivate("Leave")

			TakeQuest("CD_PH03")

			SetVar("MissionTime", 0)

			AddFadingMsgId("fm_aircraft_enroute_foe")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="CITBattleshipDestroyed" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="ThePendulum" />
		<event eventid="GE_OBJECT_DIE" ObjName="CITBattleship01_vehicle_0" />
		<script>
			local Friendlies = StringToTable(GetVar("Friendlies").AsString)
			local Enemies = StringToTable(GetVar("Enemies").AsString)
			local TargetEnemies = {Enemies[1]}

			if CheckUnits(TargetEnemies, "dead") then
				UpdateUnitsStats()

				CompleteQuest("CD_PH03_DestroyBattleship")

				TDeactivate("CDRocketHeavyCruiserDestroyed")

				if CheckUnits(Friendlies, "alive", 1) then
					TActivate("CDRetreat")

					CompleteQuestIfTaken("CD_PH03_ProtectCruiser")

					AddFadingMsgId("fm_cd_ph03_cdretreating")
				end

				TakeQuest("CD_PH03_Retreat")

				PlayMusic("bs_armada_retreat")

				if CheckDistBetweenUnits(GetPlayerVehicle(), Enemies, "least") >= 1500 then
					local b = SpawnMessageBox( "1001" )
					println("mission end 0")
					if b == 1 then
						trigger:Deactivate()

						CompleteQuestIfTaken("CD_PH03_Retreat")

						println("mission end 1")

						UpdateUnitsStats()

						CalcMissionStats()

						println("mission end 3")

						PassToMap("hq", "Headquarters_enter", 90, false )
					else
						TActivate("MissionEnd")
					end
				else
					TActivate("MissionEnd")
				end

				trigger:Deactivate()
			else
				if GetVar("CITBattleshipDetected").AsInt~=nil then
					UpdateQuestCoordinates("CD_PH03_DestroyBattleship", TargetEnemies)
				end
			end

		</script>
	</trigger>

	<trigger Name="CITFormationManager" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="ThePendulum" />
		<script>
			local Unit
			local Enemies = StringToTable(GetVar("Enemies").AsString)
			local TargetEnemies = {Enemies[1],Enemies[2],Enemies[3],Enemies[4],Enemies[5],Enemies[6]}
			
			if CheckUnits(TargetEnemies, "alive", 1) then
				Unit = getObj("CITBattleship01_vehicle_0")
				if Unit then
					Unit:SetCruisingSpeed(3)
				end

				for i=0,2 do
					Unit = getObj("CITOldCruiser01_vehicle_"..i)
					if Unit then
						Unit:SetCruisingSpeed(3)
					end
				end

				for i=0,3 do
					Unit = getObj("CITDestroyer01_vehicle_"..i)
					if Unit then
						Unit:SetCruisingSpeed(3)
					end
				end
			else
				LOG("CIT FORMATION MANAGER DISABLED BY ITSELF")

				trigger:Deactivate()
			end

		</script>
	</trigger>

	<trigger Name="CITCriticalLosses" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="ThePendulum" />
		<event eventid="GE_OBJECT_DIE" ObjName="CITBattleship01_vehicle_0" />
		<event eventid="GE_OBJECT_DIE" ObjName="CITOldCruiser01_vehicle_0" />
		<event eventid="GE_OBJECT_DIE" ObjName="CITOldCruiser01_vehicle_1" />
		<event eventid="GE_OBJECT_DIE" ObjName="CITOldCruiser01_vehicle_2" />
		<event eventid="GE_OBJECT_DIE" ObjName="CITDestroyer01_vehicle_0" />
		<event eventid="GE_OBJECT_DIE" ObjName="CITDestroyer01_vehicle_1" />
<!--		<event eventid="GE_OBJECT_DIE" ObjName="CITDestroyer01_vehicle_2" />
		<event eventid="GE_OBJECT_DIE" ObjName="CITDestroyer01_vehicle_3" /> -->
		<script>
			local Enemies = StringToTable(GetVar("Enemies").AsString)
			local TargetEnemies = {Enemies[1],Enemies[2],Enemies[3],Enemies[4],Enemies[5],Enemies[6]}
			local EnemiesHealth = StringToTable(GetVar("EnemiesEndHealth").AsString)
			local TotalHealth = 0
			for i=1, getn(TargetEnemies) do
				TotalHealth = TotalHealth + EnemiesHealth[i]
			end

			if CheckUnits(TargetEnemies, "dead", 4) or 4100 >= TotalHealth then
				PlayMusic("bs_armada_combat")

				UpdateUnitsStats()
				
				AddFadingMsgId("fm_critical_loss_foe")

				TDeactivate("CITFormationManager")
				TActivate("CITRetreat")

				if CheckUnits({"CDRocketHeavyCruiser01_vehicle_0","CITBattleship01_vehicle_0"}, "alive", 2) then
					LOG("CITCriticalLosses Unit Check Passed")
					getObj("CDRocketHeavyCruiser01"):StackOpen()
					getObj("CDRocketHeavyCruiser01"):SetDestination(getObj("CITBattleship01_vehicle_0"):GetPosition())
					getObj("CDRocketHeavyCruiser01"):StackClose()
					LOG("CITCriticalLosses Unit Check End")
				end

				LOG("CITCriticalLosses End")

				trigger:Deactivate()
			end
			
		</script>
	</trigger>

	<trigger Name="CITRetreat" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="ThePendulum" />
		<script>
			local Unit
			local Enemies = StringToTable(GetVar("Enemies").AsString)

			Unit = getObj("CITBattleship01")
			if Unit then
				Unit:SetProperty ("TeamTacticPrototype", "CowardTeamTactic")
				Unit:_AdjustBehaviour ()
			end
			Unit = getObj("CITOldCruiser01")
			if Unit then
				Unit:SetProperty ("TeamTacticPrototype", "CowardTeamTactic")
				Unit:_AdjustBehaviour ()
			end
			Unit = getObj("CITDestroyer01")
			if Unit then
				Unit:SetProperty ("TeamTacticPrototype", "CowardTeamTactic")
				Unit:_AdjustBehaviour ()
			end

			Unit = getObj(Enemies[1])
			if Unit then
				Unit:SetExternalPathByName("CITRetreatDirection_1")
				Unit:SetCanBeDistractedFromMoving(true)
				Unit:SetCruisingSpeed(40)
			end

			for i=2,8 do
				Unit = getObj(Enemies[i])
				if Unit then
					Unit:SetExternalPathByName("CITRetreatDirection_"..i)
					Unit:SetCanBeDistractedFromMoving(false)
					Unit:SetCruisingSpeed(40)
				end
			end

			AddImportantFadingMsgByStrIdFormatted("fm_retreat_attempt_foe")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="CDRocketHeavyCruiserDestroyed" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="ThePendulum" />
		<event eventid="GE_OBJECT_DIE" ObjName="CDRocketHeavyCruiser01_vehicle_0" />
		<script>
			local Unit
			local Friendlies = StringToTable(GetVar("Friendlies").AsString)
			local TargetFriendlies = {Friendlies[1]}

			if CheckUnits(TargetFriendlies, "dead") then
				UpdateUnitsStats()

				FailQuest("CD_PH03_ProtectCruiser")

				if not(IsQuestTaken("CD_PH03_Retreat")) then
					AddImportantFadingMsgByStrIdFormatted("fm_cd_ph03_completemission")

					PlayMusic("bs_armada_combat")
				end

				for i=2, getn(Friendlies) do
					if CheckUnits(Friendlies[i]) then
						Unit = getObj(Friendlies[i])
						Unit:SetCanBeDistractedFromMoving(true)
					end
				end

				trigger:Deactivate()
			elseif 3300 > getObj(TargetFriendlies[1]):GetHealth() then
				LOG("CD destroyers aggroed")
				for i=0, 2 do
					Unit = getObj("CDDestroyer01_vehicle_"..i)
--					if Unit and not(getObj("")) then
					if Unit then
						Unit:SetCanBeDistractedFromMoving(true)
					end
				end
			elseif 4400 > getObj(TargetFriendlies[1]):GetHealth() then
				if not(IsQuestTaken("CD_PH03_ProtectCruiser")) then
					TakeQuest("CD_PH03_ProtectCruiser")
				end
			end

		</script>
	</trigger>

	<trigger Name="CDFormationManager" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="ThePendulum" />
		<script>
			local Friendlies = StringToTable(GetVar("Friendlies").AsString)
			local CDRHC01a = getObj("CDRocketHeavyCruiser01_vehicle_0")
			local CDD01a = getObj("CDDestroyer01_vehicle_0")
			local CDD01b = getObj("CDDestroyer01_vehicle_1")
			local CDD01c = getObj("CDDestroyer01_vehicle_2")
			
			if CheckUnits(Friendlies, "alive", 1) then
				if CDRHC01a then
					CDRHC01a:SetCruisingSpeed(5)
				end

				if CDD01a then
					CDD01a:SetCruisingSpeed(5)
				end

				if CDD01b then
					CDD01b:SetCruisingSpeed(5)
				end

				if CDD01c then
					CDD01c:SetCruisingSpeed(5)
				end
			else
				LOG("CD FORMATION MANAGER DISABLED BY ITSELF")

				trigger:Deactivate()
			end

			-- ================ --
			-- Waypoint Manager --
			-- ================ --
			local vehicles = Friendlies
			local currentVehicleName -- "CDDestroyer01"
			local currentVehicle -- = getObj("CDDestroyer01_vehicle_0")
			local speedThreshold = 3 -- the speed at which the vehicle is deemed suspiciously still
			local checksAmount = 0
			LOG("662")
			for j=1, getn(vehicles) do
				LOG(j.." 664")
				currentVehicleName = vehicles[j]
				currentVehicle = getObj(currentVehicleName)
				LOG(j.." 667")
				if CheckUnits(currentVehicleName) then
					LOG(j.." 669")
					println(currentVehicleName.." exists")
					if GetVar(currentVehicleName.."SpeedCheck").AsInt~=nil then
						currentVehicleSpeedCheck = GetVar(currentVehicleName.."SpeedCheck").AsInt
						LOG(j.." 673")
					else
						SetVar(currentVehicleName.."SpeedCheck", 0)
						currentVehicleSpeedCheck = 0
						LOG(j.." 677")
					end
					LOG(j.." 679")
					if speedThreshold > GetSpeed(currentVehicle) then
						LOG(j.." 681")
						println(currentVehicleName.." speed is too low")
						checksAmount = currentVehicleSpeedCheck + 1 -- the speed of the vehicle is too low, the check has passed one more time
						println("checks amount is "..checksAmount)
						LOG(j.." 685")
						if checksAmount >= 3 then
							LOG(j.." 687")
							println("there have been 3 checks for "..currentVehicleName)
							currentVehicle:SetExternalPathByName(currentVehicleName.."_Waypoint1") -- the vehicle is set on the path for the current waypoint
							currentVehicle:SetCanBeDistractedFromMoving(true) -- set this to false or remove the line if this trigger is used for racing, lol
							println(currentVehicleName.." set for the current waypoint")
							LOG(j.." 692")
						end
					else
						LOG(j.." 695")
						println(currentVehicleName.." speed is fine")
						checksAmount = 0 -- the speed of the vehicle is okay, the checks are dropped
					end

					LOG(j.." 700")
					SetVar(currentVehicleName.."SpeedCheck", checksAmount)
					println(currentVehicleName.." waypoint info updated")
					LOG(j.." 703")
				end
			end

		</script>
	</trigger>

	<trigger Name="CDOrder" active="0">
		<event eventid="GE_NOTICE_ENEMY" ObjName="CITBattleship01_vehicle_0" />
		<event eventid="GE_UNDER_ATTACK" ObjName="CITBattleship01_vehicle_0" />
		<event eventid="GE_NOTICE_ENEMY" ObjName="CITOldCruiser01_vehicle_0" />
		<event eventid="GE_UNDER_ATTACK" ObjName="CITOldCruiser01_vehicle_0" />
		<event eventid="GE_NOTICE_ENEMY" ObjName="CITOldCruiser01_vehicle_1" />
		<event eventid="GE_UNDER_ATTACK" ObjName="CITOldCruiser01_vehicle_1" />
		<event eventid="GE_NOTICE_ENEMY" ObjName="CITOldCruiser01_vehicle_2" />
		<event eventid="GE_UNDER_ATTACK" ObjName="CITOldCruiser01_vehicle_2" />
		<event eventid="GE_NOTICE_ENEMY" ObjName="CITDestroyer01_vehicle_0" />
		<event eventid="GE_UNDER_ATTACK" ObjName="CITDestroyer01_vehicle_0" />
		<event eventid="GE_NOTICE_ENEMY" ObjName="CITDestroyer01_vehicle_1" />
		<event eventid="GE_UNDER_ATTACK" ObjName="CITDestroyer01_vehicle_1" />
<!--		<event eventid="GE_NOTICE_ENEMY" ObjName="CITDestroyer01_vehicle_2" />
		<event eventid="GE_UNDER_ATTACK" ObjName="CITDestroyer01_vehicle_2" />
		<event eventid="GE_NOTICE_ENEMY" ObjName="CITDestroyer01_vehicle_3" />
		<event eventid="GE_UNDER_ATTACK" ObjName="CITDestroyer01_vehicle_3" /> -->
		<script>
			local Unit
			local Enemies = StringToTable(GetVar("Enemies").AsString)
			local TargetEnemies = {Enemies[1]}

			UpdateUnitsStats()

			TDeactivate("CDFormationManager")

			Unit = getObj("CDRocketHeavyCruiser01_vehicle_0")
			if Unit then
				Unit:SetExternalPathByName("CDRocketHeavyCruiser01_vehicle_0_Waypoint1")
				Unit:SetCruisingSpeed(40)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			for i=0, 2 do
				Unit = getObj("CDDestroyer01_vehicle_"..i)
				if Unit then
					Unit:SetExternalPathByName("CDDestroyer01_vehicle_"..i.."_Waypoint1")
					Unit:SetCruisingSpeed(40)
					Unit:SetCanBeDistractedFromMoving(true)
				end
			end

			AddImportantFadingMsgByStrIdFormatted("fm_cd_ph03_destroybattleship")

			UpdateQuestCoordinates("CD_PH03_DestroyBattleship", TargetEnemies)

			SetVar("CITBattleshipDetected", 1)

			PlayMusic("bs_armada_combat")

			if CheckUnits({"CDRocketHeavyCruiser01_vehicle_0","CITBattleship01_vehicle_0"}, "alive", 2) and 1700 >= CheckDistBetweenUnits("CDRocketHeavyCruiser01_vehicle_0", Enemies, "least") then
				LOG("CDOrder Unit Check Passed")
				getObj("CDRocketHeavyCruiser01"):StackOpen()
				getObj("CDRocketHeavyCruiser01"):SetDestination(getObj("CITBattleship01_vehicle_0"):GetPosition())
				getObj("CDRocketHeavyCruiser01"):StackClose()
				LOG("CDOrder Unit Check End")
			end

			LOG("CDOrder End")
			
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="CDCriticalLosses" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="ThePendulum" />
		<event eventid="GE_OBJECT_DIE" ObjName="CDRocketHeavyCruiser01_vehicle_0" />
		<event eventid="GE_OBJECT_DIE" ObjName="CDDestroyer01_vehicle_0" />
		<event eventid="GE_OBJECT_DIE" ObjName="CDDestroyer01_vehicle_1" />
<!--		<event eventid="GE_OBJECT_DIE" ObjName="CDDestroyer01_vehicle_2" /> -->
		<script>
			local Friendlies = StringToTable(GetVar("Friendlies").AsString)
			local FriendliesHealth = StringToTable(GetVar("FriendliesEndHealth").AsString)
			local PlayerHealth = StringToTable(GetVar("PlayerEndHealth").AsString)
			local TotalHealth = 0
			for i=1, getn(FriendliesHealth) do
				TotalHealth = TotalHealth + FriendliesHealth[i]
			end
			TotalHealth = TotalHealth + PlayerHealth

			if CheckUnits(Friendlies, "dead", 3) or 4500 > TotalHealth then
				UpdateUnitsStats()

				AddFadingMsgId("fm_critical_loss_ally")

				TDeactivate("CDFormationManager")
				TActivate("CDRetreat")

				TakeQuest("CD_PH03_Retreat")

				AddImportantFadingMsgByStrIdFormatted("fm_cd_ph03_abortmission")

				trigger:Deactivate()
			end
			
		</script>
	</trigger>

	<trigger Name="CDRetreat" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="ThePendulum" />
		<script>
			local Unit
			local Friendlies = StringToTable(GetVar("Friendlies").AsString)

			Unit = getObj("CDRocketHeavyCruiser01")
			if Unit then
				Unit:SetProperty ("TeamTacticPrototype", "CowardTeamTactic")
				Unit:_AdjustBehaviour ()
			end
			Unit = getObj("CDDestroyer01")
			if Unit then
				Unit:SetProperty ("TeamTacticPrototype", "CowardTeamTactic")
				Unit:_AdjustBehaviour ()
			end

			for i=1,getn(Friendlies) do
				Unit = getObj(Friendlies[i])
				if Unit then
					Unit:SetExternalPathByName("CDRetreatDirection_"..i)
					Unit:SetCanBeDistractedFromMoving(false)
					Unit:SetCruisingSpeed(40)
				end
			end

			AddImportantFadingMsgByStrIdFormatted("fm_retreat_attempt_ally")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="MissionEnd" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="ThePendulum" />
		<script>
			local Enemies = StringToTable(GetVar("Enemies").AsString)

			if CheckDistBetweenUnits(GetPlayerVehicle(), Enemies, "least") >= 1500 then
				local b = SpawnMessageBox( "1001" )
				println("mission end 0")
				trigger:Deactivate()
				if b == 1 then
					CompleteQuestIfTaken("CD_PH03_Retreat")

					println("mission end 1")

					UpdateUnitsStats()

					CalcMissionStats()

					println("mission end 3")

					PassToMap("hq", "Headquarters_enter", 90, false )
				end
			end

		</script>
	</trigger>
</triggers>