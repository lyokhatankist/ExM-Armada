<?xml version="1.0" encoding="windows-1251" standalone="yes" ?>
<triggers>
	<trigger Name="GlobalVar" active="1">
		<event timeout="0" eventid="GE_TIME_PERIOD" />
		<script>
			g_ObjCont:SetGameTime( gMissionTime[1], gMissionTime[2], gMissionTime[3], gMissionTime[4], gMissionTime[5] )
			
			SetWeather(0)

			ShowMap()

			Radar:SetScanRadius(1000)

			GetPlayerVehicle():setImmortalMode(1)
			GetPlayerVehicle():SetNameFromScript("MyCar")
			SetCameraBehindPlayerVehicle()
			TActivate("PlayerDead")

			local friendly = {}
			local enemy = {}
			--                {objName                  Type               Prototype      EffHP VehHP FP Maneuv.      FriendlyName}
			friendly[1] = {"CITOldCruiser01_vehicle_0", "CITOldCruiserAegean", "CITPH02_OCruiserCIT01", 2000, 2000, 10967, 20, "«Эльберет» (л.к.т. «Эгаль»)"}
			friendly[2] = {"CITDestroyer01_vehicle_0", "CITDestroyerAegean", "CITPH02_DestroyerCIT01", 1200, 1200, 9680, 30, "«Жеводан» (э.м.т. «Лион»)"}
			friendly[3] = {"CITDestroyer01_vehicle_1", "CITDestroyerAegean", "CITPH02_DestroyerCIT02", 1200, 1200, 6868, 26, "«Руан» (э.м.т. «Лион»)"}
			friendly[4] = {"CITHelicopter01_vehicle_0", "CITHelicopterLeaderAegean", "CITPH02_HeliCIT02", 20, 500, 2864, 110, "у.в. «Кондор» (л.в.з., поз. «Сокол»)"}
			friendly[5] = {"CITHelicopter01_vehicle_1", "CITHelicopterAegean", "CITPH02_HeliCIT02", 20, 500, 2864, 110, "none"}
			friendly[6] = {"CITHelicopter02_vehicle_0", "CITHelicopterLeaderAegean", "CITPH02_HeliCIT02", 20, 500, 2864, 110, "у.в. «Кондор» (л.в.з., поз. «Гром»)"}
			friendly[7] = {"CITHelicopter02_vehicle_1", "CITHelicopterAegean", "CITPH02_HeliCIT02", 20, 500, 2864, 110, "none"}
			friendly[8] = {"CITHelicopter03_vehicle_0", "CITHelicopterLeaderAegean", "CITPH02_HeliCIT02", 20, 500, 2864, 110, "у.в. «Кондор» (л.в.з., поз. «Филин»)"}
			friendly[9] = {"CITHelicopter03_vehicle_1", "CITHelicopterAegean", "CITPH02_HeliCIT02", 20, 500, 2864, 110, "none"}
			friendly[10] = {"CITHelicopter04_vehicle_0", "CITHelicopterLeaderAegean", "CITPH02_HeliCIT02", 20, 500, 2864, 110, "у.в. «Кондор» (л.в.з., поз. «Скиф»)"}
			friendly[11 ] = {"CITHelicopter04_vehicle_1", "CITHelicopterAegean", "CITPH02_HeliCIT02", 20, 500, 2864, 110, "none"}
			--                {objName      EffHP VehHP FP Maneuv.}
			enemy[1] = {"CDDestroyer01_vehicle_0", 1600, 1600, 6601, 22}
			enemy[2] = {"CDDestroyer01_vehicle_1", 1600, 1600, 6601, 22}
			enemy[3] = {"CDHeavyCruiser01_vehicle_0", 4000, 4000, 18551, 12}
			enemy[4] = {"CDBattleship01_vehicle_0", 6000, 6000, 20737, 7}
			enemy[5] = {"CDBattleship01_vehicle_1", 6000, 6000, 40565, 7}
			enemy[6] = {"CDHelicopter01_vehicle_0", 13, 250, 627, 140}
			enemy[7] = {"CDHelicopter01_vehicle_1", 13, 250, 627, 140}
			enemy[8] = {"CDHelicopter01_vehicle_2", 13, 250, 627, 140}
			enemy[9] = {"CDHelicopter01_vehicle_3", 13, 250, 627, 140}
			enemy[10] = {"CDHelicopter02_vehicle_0", 13, 250, 627, 140}
			enemy[11] = {"CDHelicopter02_vehicle_1", 13, 250, 627, 140}
			enemy[12] = {"CDHelicopter02_vehicle_2", 13, 250, 627, 140}
			enemy[13] = {"CDHelicopter02_vehicle_3", 13, 250, 627, 140}

			SetVar("MissionTime", 0)
			SetVar("RequiredMissionTime", 400) -- mission completion time (in s) for getting bonus score
			SetVar("BaseRetreatScore", 40) -- base retreat score that may get multiplied depending on 4 different factors
			SetVar("RequiredRetreatScore", 45) -- retreat score that needs to be reached for each friendly unit to successfully retreat
			SetVar("PlayerHealth", 1200)
			SetVar("PlayerVehicleHealth", 1200)
			SetVar("PlayerEndHealth", GetVar("PlayerHealth").AsInt)
			SetVar("PlayerName", "«Прованс» (э.м.т. «Лион»)")
			SetVar("Objectives", 2) -- amount of main objectives, excluding destruction of all enemy units and completing the mission without losses
			SetVar("ObjectiveScoreReward", 35000) -- how much score each objective gives
			SetVar("MissionScoreRewardMultiplier", 0.115) -- multiplier that determines how much money the player will receive for each score point

			local j = 1
			local friendlies = {}
			while friendly[j] do
				friendlies[j] = friendly[j][1]
				j = j + 1
			end
			friendlies = TableToString(friendlies)
			j = 1
			local friendliesTypes = {}
			while friendly[j] do
				friendliesTypes[j] = friendly[j][2]
				j = j + 1
			end
			friendliesTypes = TableToString(friendliesTypes)
			j = 1
			local friendliesPrototypes = {}
			while friendly[j] do
				friendliesPrototypes[j] = friendly[j][3]
				j = j + 1
			end
			friendliesPrototypes = TableToString(friendliesPrototypes)
			j = 1
			local friendliesHealth = {}
			while friendly[j] do
				friendliesHealth[j] = friendly[j][4]
				j = j + 1
			end
			friendliesHealth = TableToString(friendliesHealth)
			j = 1
			local friendliesVehicleHealth = {}
			while friendly[j] do
				friendliesVehicleHealth[j] = friendly[j][5]
				j = j + 1
			end
			friendliesVehicleHealth = TableToString(friendliesVehicleHealth)
			j = 1
			local friendliesFirepower = {}
			while friendly[j] do
				friendliesFirepower[j] = friendly[j][6]
				j = j + 1
			end
			friendliesFirepower = TableToString(friendliesFirepower)
			j = 1
			local friendliesManeuverability = {}
			while friendly[j] do
				friendliesManeuverability[j] = friendly[j][7]
				j = j + 1
			end
			friendliesManeuverability = TableToString(friendliesManeuverability)
			j = 1
			local friendliesNames = {}
			while friendly[j] do
				friendliesNames[j] = friendly[j][8]
				j = j + 1
			end
			friendliesNames = TableToString(friendliesNames)

			j = 1
			local enemies = {}
			while enemy[j] do
				enemies[j] = enemy[j][1]
				j = j + 1
			end
			enemies = TableToString(enemies)
			j = 1
			local enemiesHealth = {}
			while enemy[j] do
				enemiesHealth[j] = enemy[j][2]
				j = j + 1
			end
			enemiesHealth = TableToString(enemiesHealth)
			j = 1
			local enemiesVehicleHealth = {}
			while enemy[j] do
				enemiesVehicleHealth[j] = enemy[j][3]
				j = j + 1
			end
			enemiesVehicleHealth = TableToString(enemiesVehicleHealth)
			j = 1
			local enemiesFirepower = {}
			while enemy[j] do
				enemiesFirepower[j] = enemy[j][4]
				j = j + 1
			end
			enemiesFirepower = TableToString(enemiesFirepower)
			j = 1
			local enemiesManeuverability = {}
			while enemy[j] do
				enemiesManeuverability[j] = enemy[j][5]
				j = j + 1
			end
			enemiesManeuverability = TableToString(enemiesManeuverability)
			SetVar("TotalMissionScore", 0) -- total score gained, gets updated after mission stats calculation with the info about destroyed enemy units; score for enemy units is decided by their firepower
			SetVar("ObjectivesCompleted", 0)
			SetVar("Friendlies", friendlies)
			SetVar("FriendliesTypes", friendliesTypes)
			SetVar("FriendliesPrototypes", friendliesPrototypes)
			SetVar("FriendliesHealth", friendliesHealth) -- friendlies effective hp
			SetVar("FriendliesVehicleHealth", friendliesVehicleHealth) -- friendlies real hp according to the vehicle stats, used in UpdateUnitsStats
			SetVar("FriendliesEndHealth", friendliesHealth) -- friendlies hp at the end of the mission, are updated by UpdateUnitsStats
			SetVar("FriendliesFirepower", friendliesFirepower)
			SetVar("FriendliesManeuverability", friendliesManeuverability)
			SetVar("FriendliesNames", friendliesNames)
			SetVar("Enemies", enemies)
			SetVar("EnemiesHealth", enemiesHealth) -- enemies effective hp
			SetVar("EnemiesVehicleHealth", enemiesVehicleHealth) -- enemies real hp according to the vehicle stats, used in UpdateUnitsStats
			SetVar("EnemiesEndHealth", enemiesHealth) -- enemies hp at the end of the mission, are updated by UpdateUnitsStats
			SetVar("EnemiesFirepower", enemiesFirepower)
			SetVar("EnemiesManeuverability", enemiesManeuverability)
			

			if not getObj("ThePendulum") then
				CreateVehicleEx("PendulumVehicle01", "ThePendulum", CVector(30, 255, 80), 1486)
				local Maschine = getObj("ThePendulum")
				if Maschine then
					Maschine:setGodMode(1)
					Maschine:setImmortalMode(1)
					Maschine:SetExternalPathByName("PendulumPath")
					
					TActivate("trPendulum")
				end
			end

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="trPendulum" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="ThePendulum" />
		<event eventid="GE_GAME_START" ObjName="Player1" />
		<script>
			local Maschine = GetEntityByName("ThePendulum")
			if Maschine then
				Maschine:SetLinearVelocity(CVector(0, 0, 0))
				Maschine:SetExternalPathByName("PendulumPath")
				local PendulumStat = GetVar("PendulumStatus").AsInt
				local MissionTime = GetVar("MissionTime").AsInt
				if 50>PendulumStat then
					PendulumStat = PendulumStat + 1
					SetVar("PendulumStatus", PendulumStat)
					println("pendstat set to "..PendulumStat)
					MissionTime = MissionTime + 8
					SetVar("MissionTime", MissionTime)
				else
					SetVar("PendulumStatus", 0)
					println("corovan management activated, pendstat set to 0")
					MissionTime = MissionTime + 8
					SetVar("MissionTime", MissionTime)
				end
			end

		</script>
	</trigger>

	<trigger Name="RetreatStart" active="0">
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="MissionStartLoc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Retreat01Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Retreat02Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Retreat03Loc" />
		<script>
			TActivate("Retreat")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Retreat" active="0">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="MissionStartLoc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Retreat01Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Retreat02Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Retreat03Loc" />
		<script>
			UpdateUnitsStats()

			local b = SpawnMessageBox( "1000" )
			if b == 1 then
				trigger:Deactivate()

				if not(IsQuestTaken("CIT_PH04_Retreat")) then
					FailQuest("CIT_PH04")
				else
					CompleteQuest("CIT_PH04_Retreat")
				end

				UpdateUnitsStats()

				CalcMissionStats()

				PassToMap("hq", "Headquarters_enter", 90, false )
			else
				trigger:Deactivate()

				TActivate("RetreatStart")
			end
			
		</script>
	</trigger>

	<trigger Name="Leave" active="0">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Leave01Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Leave02Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Leave03Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Leave04Loc" />
		<script>
			if not(IsQuestTaken("CIT_PH04_Retreat")) then
				FailQuest("CIT_PH04")
			else
				CompleteQuest("CIT_PH04_Retreat")
			end

			UpdateUnitsStats()

			CalcMissionStats()

			PassToMap("hq", "Headquarters_enter", 90, false)
			
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="WarningStart" active="0">
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning01Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning02Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning03Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning04Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning05Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning06Loc" />
		<event eventid="GE_OBJECT_LEAVES_LOCATION" ObjName="Warning07Loc" />
		<script>
			TActivate("Warning")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Warning" active="1">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning01Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning02Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning03Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning04Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning05Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning06Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Warning07Loc" />
		<script>
			local b = SpawnMessageBox( "1002" )

			TActivate("WarningStart")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Desertion" active="1">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion01Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion02Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion03Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion04Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion05Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion06Loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Desertion07Loc" />
		<script>
			if not(IsQuestTaken("CIT_PH04_Retreat")) then
				FailQuest("CIT_PH04")
			else
				FailQuest("CIT_PH04_Retreat")
				FailQuest("CIT_PH04")
			end

			UpdateUnitsStats(1) -- the trigger is identical to Leave, besides this (1)

			CalcMissionStats(1) -- the trigger is identical to Leave, besides this (1)

			PassToMap("hq", "Headquarters_enter", 90, false)
			
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="MissionStart" active="1">
		<event timeout="0" eventid="GE_TIME_PERIOD" />
		<script>
			local Units
			local Unit
			-- ================
			--  Main CIT Force
			-- ================
			TeamCreate("CITOldCruiser01", 1004, CVector(1061, 285, 5954), {"CITPH02_OldCruiserCIT01"})
			TeamCreate("CITDestroyer01", 1003, CVector(1183, 285, 5904), {"CITPH02_DestroyerCIT01", "CITPH02_DestroyerCIT02"})

			TeamCreate("CITHelicopter01", 1006, CVector(7801, 285, 8004), {"CITPH02_HeliCIT0"..math.random(4),"CITPH02_HeliCIT0"..math.random(4)})
			TeamCreate("CITHelicopter01", 1006, CVector(7895, 285, 7898), {"CITPH02_HeliCIT0"..math.random(4),"CITPH02_HeliCIT0"..math.random(4)})
			TeamCreate("CITHelicopter01", 1006, CVector(8012, 285, 8053), {"CITPH02_HeliCIT0"..math.random(4),"CITPH02_HeliCIT0"..math.random(4)})
			TeamCreate("CITHelicopter01", 1006, CVector(8050, 285, 7939), {"CITPH02_HeliCIT0"..math.random(4),"CITPH02_HeliCIT0"..math.random(4)})

			-- ----------------
			-- Units parameters

			Units = getObj("CITOldCruiser01")
			if Units then
				Units:SetProperty ("TeamTacticPrototype", "StandardTactic")
				Units:_AdjustBehaviour ()
			end

			Units = getObj("CITDestroyer01")
			if Units then
				Units:SetProperty ("TeamTacticPrototype", "BoxTactic")
				Units:_AdjustBehaviour ()
			end

			-- ---------------
			-- Unit parameters

			Unit = getObj("CITOldCruiser01_vehicle_0")
			if Unit then
				Unit:SetRotation(Quaternion(0.0000, 0.9239, 0.0000, 0.3827))
				Unit:SetCruisingSpeed(8)
				Unit:SetExternalPathByName("StartPath_CITOldCruiser01_vehicle_0")
			end

			Unit = getObj("CITDestroyer01_vehicle_0")
			if Unit then
				Unit:SetRotation(Quaternion(0.0000, 0.9239, 0.0000, 0.3827))
				Unit:SetCruisingSpeed(8)
				Unit:SetExternalPathByName("StartPath_CITDestroyer01_vehicle_0")
			end

			Unit = getObj("CITDestroyer01_vehicle_1")
			if Unit then
				Unit:SetGamePositionOnGround(CVector(987, 285, 6076))
				Unit:SetRotation(Quaternion(0.0000, 0.9239, 0.0000, 0.3827))
				Unit:SetCruisingSpeed(8)
				Unit:SetExternalPathByName("StartPath_CITDestroyer01_vehicle_1")
			end

			coords = {{CVector(7801, 285, 8004), CVector(7801, 285, 8054)},
					  {CVector(7895, 285, 7898), CVector(7923, 285, 7941)},
					  {CVector(8012, 285, 8053), CVector(8031, 285, 8102)},
					  {CVector(8050, 285, 7939), CVector(8082, 285, 7997)}}
			for i=1, 4 do
				for j=0, 1 do
					Unit = getObj("CITHelicopter0"..i.."_vehicle_"..j)
					if Unit then
						Unit:SetGamePositionOnGround(coords[i][j+1])
						Unit:SetRotation(Quaternion(0.0000, -0.8660, 0.0000, 0.5000))
					end
				end
			end

			-- ===============
			--  Main CD Force
			-- ===============
			TeamCreate("CDDestroyer01", 1053, CVector(3487, 285, 2450), {"CITPH02_DestroyerCD01", "CITPH02_DestroyerCD01"})
			TeamCreate("CDHeavyCruiser01", 1054, CVector(3612, 285, 2377), {"CITPH02_HCruiserCD01"})
			TeamCreate("CDBattleship01", 1055, CVector(3563, 285, 2207), {"CITPH02_BattleshipCD01", "CITPH02_BattleshipCD02"})

			-- =============
			--  CD Reserves
			-- =============
			TeamCreate("CDHelicopter01", 1056, CVector(4152, 285, 157), {"CITPH02_HeliCD0"..math.random(4),"CITPH02_HeliCD0"..math.random(4),"CITPH02_HeliCD0"..math.random(4),"CITPH02_HeliCD0"..math.random(4)})
			TeamCreate("CDHelicopter02", 1056, CVector(4314, 285, 63), {"CITPH02_HeliCD0"..math.random(4),"CITPH02_HeliCD0"..math.random(4),"CITPH02_HeliCD0"..math.random(4),"CITPH02_HeliCD0"..math.random(4)})

			-- ----------------
			-- Units parameters

			Units = getObj("CDDestroyer01")
			if Units then
				Units:SetProperty ("TeamTacticPrototype", "BoxTactic")
				Units:_AdjustBehaviour ()
			end

			Units = getObj("CDHeavyCruiser01")
			if Units then
				Units:SetProperty ("TeamTacticPrototype", "StandardTactic")
				Units:_AdjustBehaviour ()
			end
	
			Units = getObj("CDBattleship01")
			if Units then
				Units:SetProperty ("TeamTacticPrototype", "SniperTactic")
				Units:_AdjustBehaviour ()
			end

			Units = getObj("CDHelicopter01")
			if Units then
				Units:SetProperty ("TeamTacticPrototype", "StandardTactic")
				Units:_AdjustBehaviour ()
			end

			Units = getObj("CDHelicopter02")
			if Units then
				Units:SetProperty ("TeamTacticPrototype", "BoxTactic")
				Units:_AdjustBehaviour ()
			end

			-- ---------------
			-- Unit parameters
			
			Unit = getObj("CDDestroyer01_vehicle_0")
			if Unit then
				Unit:SetRotation(Quaternion(0.0000, -0.2483, 0.0000, 0.9687))
			end

			Unit = getObj("CDDestroyer01_vehicle_1")
			if Unit then
				Unit:SetGamePositionOnGround(CVector(3618, 285, 2522))
				Unit:SetRotation(Quaternion(0.0000, -0.2483, 0.0000, 0.9687))
			end

			Unit = getObj("CDHeavyCruiser01_vehicle_0")
			if Unit then
				Unit:SetRotation(Quaternion(0.0000, -0.2483, 0.0000, 0.9687))
			end

			Unit = getObj("CDBattleship01_vehicle_0")
			if Unit then
				Unit:SetRotation(Quaternion(0.0000, -0.2483, 0.0000, 0.9687))
			end

			Unit = getObj("CDBattleship01_vehicle_1")
			if Unit then
				Unit:SetGamePositionOnGround(CVector(3782, 285, 2327))
				Unit:SetRotation(Quaternion(0.0000, -0.2483, 0.0000, 0.9687))
			end

			coords = {{CVector(4152, 285, 157), CVector(4189, 285, 160), CVector(4236, 285, 150), CVector(4264, 285, 170)},
					  {CVector(4314, 285, 63), CVector(4352, 285, 66), CVector(4399, 285, 56), CVector(4426, 285, 76)}}
			for i=1, 2 do
				for j=0, 3 do
					Unit = getObj("CDHelicopter0"..i.."_vehicle_"..j)
					if Unit then
						Unit:SetGamePositionOnGround(coords[i][j+1])
						Unit:SetRotation(Quaternion(0.0000, -0.1305, 0.0000, 0.9914))
					end
				end
			end

			-- =========
			--  Trigger
			-- =========

			local PlfID = GetPlayerVehicleId()
			FlyLinked( "CITPH02_Start1", PlfID, 30, 0, 1, PlfID )
			StartCinematic()

			AddCinematicMessage( 1, 2)
			AddCinematicMessage( 2, 1)
			AddCinematicMessage( 3, 1)

			local Plf = GetPlayerVehicle()
			if Plf then
				Plf:SetRotation(Quaternion(0.0000, 0.9239, 0.0000, 0.3827))
				Plf:SetExternalPathByName("StartPath_Player")
				Plf:LimitMaxSpeed(16)
			end

			TActivate("MissionStart_End")
			
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="MissionStart_End" active="0">
		<event eventid="GE_END_CINEMATIC" ObjName="Player1" />
		<event eventid="GE_SKIP_CINEMATIC" ObjName="Player1" />
		<script>
			local Unit
			local Plf = GetPlayerVehicle()

			if Plf then
				Plf:PlaceToEndOfPath("StartPath_Player")
				Plf:UnlimitMaxSpeed()
			end

			Unit = getObj("CITOldCruiser01_vehicle_0")
			if Unit then
				Unit:PlaceToEndOfPath("StartPath_CITOldCruiser01_vehicle_0")
				Unit:SetExternalPathByName("CITOldCruiser01_vehicle_0_Waypoint1")
				Unit:SetCruisingSpeed(9)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CITDestroyer01_vehicle_0")
			if Unit then
				Unit:PlaceToEndOfPath("StartPath_CITDestroyer01_vehicle_0")
				Unit:SetExternalPathByName("CITDestroyer01_vehicle_0_Waypoint1")
				Unit:SetCruisingSpeed(9)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CITDestroyer01_vehicle_1")
			if Unit then
				Unit:PlaceToEndOfPath("StartPath_CITDestroyer01_vehicle_1")
				Unit:SetExternalPathByName("CITDestroyer01_vehicle_1_Waypoint1")
				Unit:SetCruisingSpeed(9)
				Unit:SetCanBeDistractedFromMoving(true)
			end	

			Unit = getObj("CDDestroyer01_vehicle_0")
			if Unit then
				Unit:SetExternalPathByName("CDDestroyer01_vehicle_0_Waypoint1")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CDDestroyer01_vehicle_1")
			if Unit then
				Unit:SetExternalPathByName("CDDestroyer01_vehicle_1_Waypoint1")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CDHeavyCruiser01_vehicle_0")
			if Unit then
				Unit:SetExternalPathByName("CDHeavyCruiser01_vehicle_0_Waypoint1")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CDBattleship01_vehicle_0")
			if Unit then
				Unit:SetExternalPathByName("CDBattleship01_vehicle_0_Waypoint1")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CDBattleship01_vehicle_1")
			if Unit then
				Unit:SetExternalPathByName("CDBattleship01_vehicle_1_Waypoint1")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			TActivate("CDDestroyed")
			TActivate("CDFormationManager")
			TActivate("CDCriticalLosses")
			TActivate("CITFormationManager")
			TActivate("CITCriticalLosses")
			TActivate("CITOrder")

			TActivate("RetreatStart")
			TActivate("Leave")

			TakeQuest("CIT_PH02")

			SetVar("MissionTime", 0)

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="CDMerchantsTargetReached" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="CDMerchant01_vehicle_0" />
		<event eventid="GE_TARGET_REACHED" ObjName="CDMerchant02_vehicle_0" />
		<script>
			local Friendlies = StringToTable(GetVar("Friendlies").AsString)

			UpdateUnitsStats()

			FailQuest("CIT_PH04_DestroyMerchants")

			if not(IsQuestTaken("CIT_PH04_Retreat")) and not(IsQuestTaken("CIT_PH04_DestroyCruisers")) then
				AddImportantFadingMsgByStrIdFormatted("fm_cit_ph04_retreat")
			end

			if CheckUnits(Friendlies, "alive", 1) then
				TActivate("CITRetreat")

				AddFadingMsgId("fm_cit_ph04_citretreating")
			end

			TakeQuest("CIT_PH04_Retreat")

			TDeactivate("CDMerchantsFormationManager")

			trigger:Deactivate()

		</script>
	</trigger>

	<trigger Name="CDMerchantsDestroyed" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="ThePendulum" />
		<event eventid="GE_OBJECT_DIE" ObjName="CDMerchant01_vehicle_0" />
		<event eventid="GE_OBJECT_DIE" ObjName="CDMerchant02_vehicle_0" />
		<script>
			local Friendlies = StringToTable(GetVar("Friendlies").AsString)
			local Enemies = StringToTable(GetVar("Enemies").AsString)
			local TargetEnemies = {Enemies[3],Enemies[4]}

			if CheckUnits(TargetEnemies, "dead", 2) then
				UpdateUnitsStats()

				CompleteQuest("CIT_PH04_DestroyMerchants")

				if not(IsQuestTaken("CIT_PH04_Retreat")) then
					AddImportantFadingMsgByStrIdFormatted("fm_cit_ph04_retreat")
				end

				if CheckUnits(Friendlies, "alive", 1) then
					TActivate("CITRetreat")

					AddFadingMsgId("fm_cit_ph04_citretreating")
				end

				TakeQuest("CIT_PH04_Retreat")

				TDeactivate("CDMerchantsTargetReached")

				if CheckDistBetweenUnits(GetPlayerVehicle(), Enemies, "least") >= 950 then
					local b = SpawnMessageBox( "1001" )
					println("mission end 0")
					if b == 1 then
						trigger:Deactivate()

						CompleteQuestIfTaken("CIT_PH04_Retreat")

						println("mission end 1")

						UpdateUnitsStats()

						CalcMissionStats()

						println("mission end 3")

						PassToMap("hq", "Headquarters_enter", 90, false )
					end
				end

				trigger:Deactivate()
			else
				UpdateQuestCoordinates("CIT_PH04_DestroyMerchants", TargetEnemies)
			end

		</script>
	</trigger>

	<trigger Name="CDMerchantsFormationManager" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="ThePendulum" />
		<script>
			local CDB01a = getObj("CDBoat01_vehicle_0")
			local CDB01b = getObj("CDBoat01_vehicle_1")
			local CDB01c = getObj("CDBoat01_vehicle_2")
			local CDB02a = getObj("CDBoat02_vehicle_0")
			local CDB02b = getObj("CDBoat02_vehicle_1")
			local CDD01a = getObj("CDDestroyer01_vehicle_0")
			local CDD01b = getObj("CDDestroyer01_vehicle_1")
			local CDM01a = getObj("CDMerchant01_vehicle_0")
			local CDM02a = getObj("CDMerchant02_vehicle_0")

			if CheckUnits("CDMerchant01_vehicle_0") or CheckUnits("CDMerchant02_vehicle_0") then
				if CDB01a then
					CDB01a:SetCruisingSpeed(3)
				end

				if CDB01b then
					CDB01b:SetCruisingSpeed(3)
				end

				if CDB01c then
					CDB01c:SetCruisingSpeed(3)
				end

				if CDB02a then
					CDB02a:SetCruisingSpeed(3)
				end

				if CDB02b then
					CDB02b:SetCruisingSpeed(3)
				end

				if CDD01a then
					CDD01a:SetCruisingSpeed(3)
				end

				if CDD01b then
					CDD01b:SetCruisingSpeed(3)
				end

				if CDM01a then
					CDM01a:SetCruisingSpeed(3)
				end

				if CDM02a then
					CDM02a:SetCruisingSpeed(3)
				end
			else
				if CDB01a then
					CDB01a:SetCruisingSpeed(40)
				end

				if CDB01b then
					CDB01b:SetCruisingSpeed(40)
				end

				if CDB01c then
					CDB01c:SetCruisingSpeed(40)
				end

				if CDB02a then
					CDB02a:SetCruisingSpeed(40)
				end

				if CDB02b then
					CDB02b:SetCruisingSpeed(40)
				end

				if CDD01a then
					CDD01a:SetCruisingSpeed(40)
				end

				if CDD01b then
					CDD01b:SetCruisingSpeed(40)
				end

				LOG("CD MERCHANT FORMATION MANAGER DISABLED BY ITSELF")

				trigger:Deactivate()
			end

		</script>
	</trigger>

	<trigger Name="CDBoatsTargetReached" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="CDBoat01_vehicle_2" />
		<event eventid="GE_TARGET_REACHED" ObjName="CDBoat02_vehicle_1" />
		<script>
			local Unit

			UpdateUnitsStats()

			Unit = getObj("CDBoat01_vehicle_0")
			if Unit then
				Unit:SetExternalPathByName("CDBoat01_Waypoint2")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CDBoat01_vehicle_1")
			if Unit then
				Unit:SetExternalPathByName("CDBoat02_Waypoint2")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CDBoat01_vehicle_2")
			if Unit then
				Unit:SetExternalPathByName("CDBoat03_Waypoint2")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CDBoat02_vehicle_0")
			if Unit then
				Unit:SetExternalPathByName("CDBoat04_Waypoint2")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			Unit = getObj("CDBoat02_vehicle_1")
			if Unit then
				Unit:SetExternalPathByName("CDBoat05_Waypoint2")
				Unit:SetCruisingSpeed(3)
				Unit:SetCanBeDistractedFromMoving(true)
			end

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="CITOrder" active="0">
		<event eventid="GE_UNDER_ATTACK" ObjName="CDMerchant01_vehicle_0" />
		<event eventid="GE_UNDER_ATTACK" ObjName="CDMerchant02_vehicle_0" />
		<event eventid="GE_NOTICE_ENEMY" ObjName="CDDestroyer01_vehicle_0" />
		<event eventid="GE_NOTICE_ENEMY" ObjName="CDDestroyer01_vehicle_1" />
		<event eventid="GE_NOTICE_ENEMY" ObjName="CDBoat01_vehicle_0" />
		<event eventid="GE_NOTICE_ENEMY" ObjName="CDBoat02_vehicle_0" />
		<script>
			local Units
			local MerchantsPos

			if CheckUnits("CDMerchant01_vehicle_0") then
				MerchantsPos = getObj("CDMerchant01_vehicle_0"):GetPosition()
			elseif CheckUnits("CDMerchant02_vehicle_0") then
				MerchantsPos = getObj("CDMerchant02_vehicle_0"):GetPosition()
			else
				MerchantsPos = CVector(4385, 255, 4175)
			end

			UpdateUnitsStats()

			Units = getObj("CITTorpedoBoat01")
			if Units then
				Units:StackOpen()
				Units:SetDestination(MerchantsPos)
				Units:SetDestination(CVector(3273, 255, 2139))
				Units:StackClose()
			end

			Units = getObj("CITTorpedoBoat02")
			if Units then
				Units:StackOpen()
				Units:SetDestination(MerchantsPos)
				Units:SetDestination(CVector(3273, 255, 2139))
				Units:StackClose()
			end

			AddImportantFadingMsgByStrIdFormatted("fm_cit_ph04_order")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="CITCriticalLosses" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="ThePendulum" />
		<event eventid="GE_OBJECT_DIE" ObjName="CITTorpedoBoat01_vehicle_0" />
		<event eventid="GE_OBJECT_DIE" ObjName="CITTorpedoBoat01_vehicle_1" />
		<event eventid="GE_OBJECT_DIE" ObjName="CITTorpedoBoat02_vehicle_0" />
		<script>
			local Friendlies = StringToTable(GetVar("Friendlies").AsString)
			local FriendliesHealth = StringToTable(GetVar("FriendliesEndHealth").AsString)
			local PlayerHealth = StringToTable(GetVar("PlayerEndHealth").AsString)
			local TotalHealth = FriendliesHealth[1] + FriendliesHealth[2] + FriendliesHealth[3] + PlayerHealth

			if CheckUnits(Friendlies, "dead", 2) or 48 >= TotalHealth then
				UpdateUnitsStats()
				
				AddFadingMsgId("fm_critical_loss_ally")

				TActivate("CITRetreat")

				trigger:Deactivate()
			end
			
		</script>
	</trigger>

	<trigger Name="CITRetreat" active="0">
		<event eventid="GE_TARGET_REACHED" ObjName="ThePendulum" />
		<script>
			local Unit
			local Friendlies = StringToTable(GetVar("Friendlies").AsString)

			Unit = getObj("CITTorpedoBoat01")
			if Unit then
				Unit:SetProperty ("TeamTacticPrototype", "CowardTeamTactic")
				Unit:_AdjustBehaviour ()
			end
			Unit = getObj("CITTorpedoBoat02")
			if Unit then
				Unit:SetProperty ("TeamTacticPrototype", "CowardTeamTactic")
				Unit:_AdjustBehaviour ()
			end

			for i=1,3 do
				Unit = getObj(Friendlies[i])
				if Unit then
					Unit:SetExternalPathByName("CITRetreatDirection_"..i)
					Unit:SetCanBeDistractedFromMoving(false)
					Unit:SetCruisingSpeed(40)
				end
			end

			AddImportantFadingMsgByStrIdFormatted("fm_retreat_attempt_ally")

			trigger:Deactivate()
		</script>
	</trigger>
</triggers>